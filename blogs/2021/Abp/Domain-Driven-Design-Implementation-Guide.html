<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Implementing Domain Driven Design | Knowledge Base - 个人技术分享</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/favicon.ico">
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?b2f6c180e095d06a0231b882e58fc0e7";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
        </script>
    <meta name="description" content="全栈开发工程师">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.3b030fed.css" as="style"><link rel="preload" href="/assets/js/app.ef01f0fb.js" as="script"><link rel="preload" href="/assets/js/4.1a620e6f.js" as="script"><link rel="preload" href="/assets/js/1.0577eaba.js" as="script"><link rel="preload" href="/assets/js/8.944d7199.js" as="script"><link rel="prefetch" href="/assets/js/10.04409825.js"><link rel="prefetch" href="/assets/js/11.c28078a7.js"><link rel="prefetch" href="/assets/js/12.af2f9992.js"><link rel="prefetch" href="/assets/js/13.0ea175ca.js"><link rel="prefetch" href="/assets/js/14.32bb99d4.js"><link rel="prefetch" href="/assets/js/15.97406a87.js"><link rel="prefetch" href="/assets/js/16.bbba74dd.js"><link rel="prefetch" href="/assets/js/17.a62fdaff.js"><link rel="prefetch" href="/assets/js/18.64c4677c.js"><link rel="prefetch" href="/assets/js/19.61e64f4b.js"><link rel="prefetch" href="/assets/js/20.1e3f3933.js"><link rel="prefetch" href="/assets/js/21.6b13545c.js"><link rel="prefetch" href="/assets/js/22.f5e49336.js"><link rel="prefetch" href="/assets/js/23.b3faa685.js"><link rel="prefetch" href="/assets/js/24.5639c7cc.js"><link rel="prefetch" href="/assets/js/25.0e3a9f75.js"><link rel="prefetch" href="/assets/js/26.0ae5f6e7.js"><link rel="prefetch" href="/assets/js/27.e185fb99.js"><link rel="prefetch" href="/assets/js/28.cf8b14c6.js"><link rel="prefetch" href="/assets/js/29.37b05781.js"><link rel="prefetch" href="/assets/js/30.1be0771e.js"><link rel="prefetch" href="/assets/js/31.8de5ead7.js"><link rel="prefetch" href="/assets/js/32.189e473f.js"><link rel="prefetch" href="/assets/js/33.6e0105ce.js"><link rel="prefetch" href="/assets/js/34.1757f1fa.js"><link rel="prefetch" href="/assets/js/35.a6082629.js"><link rel="prefetch" href="/assets/js/36.88fcb004.js"><link rel="prefetch" href="/assets/js/37.0b70b7dc.js"><link rel="prefetch" href="/assets/js/38.8eba7c80.js"><link rel="prefetch" href="/assets/js/39.2aa44bb2.js"><link rel="prefetch" href="/assets/js/40.55c62c88.js"><link rel="prefetch" href="/assets/js/5.47a6f0e4.js"><link rel="prefetch" href="/assets/js/6.f15cba4a.js"><link rel="prefetch" href="/assets/js/7.b297844b.js"><link rel="prefetch" href="/assets/js/9.bb509c3d.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.a4c136e5.js">
    <link rel="stylesheet" href="/assets/css/0.styles.3b030fed.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>Knowledge Base - 个人技术分享</h3> <p class="description" data-v-59e6cb88>全栈开发工程师</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>Gerry Ge</span>
          
        <span data-v-59e6cb88>2019 - </span>
        2023
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="Knowledge Base - 个人技术分享" class="logo"> <span class="site-name">Knowledge Base - 个人技术分享</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/ABP/" class="nav-link"><i class="undefined"></i>
  ABP
</a></li><li class="dropdown-item"><!----> <a href="/categories/MICROSERVICE/" class="nav-link"><i class="undefined"></i>
  MICROSERVICE
</a></li><li class="dropdown-item"><!----> <a href="/categories/DDD/" class="nav-link"><i class="undefined"></i>
  DDD
</a></li><li class="dropdown-item"><!----> <a href="/categories/.NET/" class="nav-link"><i class="undefined"></i>
  .NET
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  Time Line
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/gerryge" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/avatar.png" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    Gerry Ge
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>26</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>5</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/ABP/" class="nav-link"><i class="undefined"></i>
  ABP
</a></li><li class="dropdown-item"><!----> <a href="/categories/MICROSERVICE/" class="nav-link"><i class="undefined"></i>
  MICROSERVICE
</a></li><li class="dropdown-item"><!----> <a href="/categories/DDD/" class="nav-link"><i class="undefined"></i>
  DDD
</a></li><li class="dropdown-item"><!----> <a href="/categories/.NET/" class="nav-link"><i class="undefined"></i>
  .NET
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  Time Line
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/gerryge" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>Implementing Domain Driven Design</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>Gerry Ge</span>
          
        <span data-v-59e6cb88>2019 - </span>
        2023
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">Implementing Domain Driven Design</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>abp.io</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>8/24/2021</span></i> <!----> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>ABP</span><span class="tag-item" data-v-8a445198>DDD</span></i></div></div> <div class="theme-reco-content content__default"><div class="custom-block tip"><p class="title"></p><p><a href="https://docs.abp.io/en/abp/4.2/Domain-Driven-Design-Implementation-Guide" target="_blank" rel="noopener noreferrer">官方原版<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>电子书转载，中文翻译版请看 <a href="https://gerryge.com/blogs/2021/Implementing_Domain_Driven_Design/01_Introduction.html" target="_blank" rel="noopener noreferrer">实现领域驱动设计<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <h1 id="implementing-domain-driven-design"><a href="#implementing-domain-driven-design" class="header-anchor">#</a> Implementing Domain Driven Design</h1> <h2 id="introduction"><a href="#introduction" class="header-anchor">#</a> Introduction</h2> <p>This is a <strong>practical guide</strong> for implementing the Domain Driven Design (DDD). While the implementation details rely on the ABP Framework infrastructure, core concepts, principles and patterns are applicable in any kind of solution, even if it is not a .NET solution.</p> <h3 id="goals"><a href="#goals" class="header-anchor">#</a> Goals</h3> <p>The goals of this document are to</p> <ul><li><strong>Introduce and explain</strong> the DDD architecture, concepts, principles, patterns and building blocks.</li> <li>Explain the <strong>layered architecture</strong> &amp; solution structure offered by the ABP Framework.</li> <li>Introduce <strong>explicit rules</strong> to implement DDD patterns and best practices by giving <strong>concrete examples</strong>.</li> <li>Show what <strong>ABP Framework provides</strong> you as the infrastructure for implementing DDD in a proper way.</li> <li>And finally, provide <strong>suggestions</strong> based on software development <strong>best practices</strong> and our experiences to create a <strong>maintainable codebase</strong>.</li></ul> <h3 id="simple-code"><a href="#simple-code" class="header-anchor">#</a> Simple Code!</h3> <blockquote><p><strong>Playing football</strong> is very <strong>simple</strong>, but <strong>playing simple football</strong> is the <strong>hardest thing</strong> there is.
— <cite>Johan Cruyff</cite></p></blockquote> <p>If we take this famous quote for programming, we can say;</p> <blockquote><p><strong>Writing code</strong> is very <strong>simple</strong>, but <strong>writing simple code</strong> is the <strong>hardest thing</strong> there is.
— <cite>???</cite></p></blockquote> <p>In this document, we will introduce <strong>simple rules</strong>, those are <strong>easy to implement</strong>.</p> <p>Once your <strong>application grows</strong>, it will be <strong>hard to follow</strong> these rules. Sometimes you find <strong>breaking rules</strong> will save you time in a short term. However, the saved time in the short term will bring much <strong>more time loss</strong> in the middle and long term. Your code base becomes <strong>complicated</strong> and hard to maintain. Most of the business applications are <strong>re-written</strong> just because you <strong>can't maintain</strong> it anymore.</p> <p>If you <strong>follow the rules and best practices</strong>, your code base will be simpler and easier to maintain. Your application <strong>reacts to changes</strong> faster.</p> <h2 id="what-is-the-domain-driven-design"><a href="#what-is-the-domain-driven-design" class="header-anchor">#</a> What is the Domain Driven Design?</h2> <p>Domain-driven design (DDD) is an approach to software development for <strong>complex</strong> needs by connecting the implementation to an <strong>evolving</strong> model;</p> <p>DDD is suitable for <strong>complex domains</strong> and <strong>large-scale</strong> applications rather than simple CRUD applications. It focuses on the <strong>core domain logic</strong> rather than the infrastructure details. It helps to build a <strong>flexible</strong>, modular and <strong>maintainable</strong> code base.</p> <h3 id="oop-solid"><a href="#oop-solid" class="header-anchor">#</a> OOP &amp; SOLID</h3> <p>Implementing DDD highly relies on the Object Oriented Programming (OOP) and <a href="https://en.wikipedia.org/wiki/SOLID" target="_blank" rel="noopener noreferrer">SOLID<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> principles. Actually, it <strong>implements</strong> and <strong>extends</strong> these principles. So, a <strong>good understanding</strong> of OOP &amp; SOLID helps you a lot while truly implementing the DDD.</p> <h3 id="ddd-layers-clean-architecture"><a href="#ddd-layers-clean-architecture" class="header-anchor">#</a> DDD Layers &amp; Clean Architecture</h3> <p>There are four fundamental layers of a Domain Driven Based Solution;</p> <p><img src="/assets/img/domain-driven-design-layers.8d0ed9e3.png" alt="domain-driven-design-layers"></p> <p><strong>Business Logic</strong> places into two layers, the <em>Domain layer</em> and the <em>Application Layer</em>, while they contain different kinds of business logic;</p> <ul><li><strong>Domain Layer</strong> implements the core, use-case independent business logic of the domain/system.</li> <li><strong>Application Layer</strong> implements the use cases of the application based on the domain. A use case can be thought as a user interaction on the User Interface (UI).</li> <li><strong>Presentation Layer</strong> contains the UI elements (pages, components) of the application.</li> <li><strong>Infrastructure Layer</strong> supports other layer by implementing the abstractions and integrations to 3rd-party library and systems.</li></ul> <p>The same layering can be shown as the diagram below and known as the <strong>Clean Architecture</strong>, or sometimes the <strong>Onion Architecture</strong>:</p> <p><img src="/assets/img/domain-driven-design-clean-architecture.1f6cd266.png" alt="domain-driven-design-clean-architecture"></p> <p>In the Clean Architecture, each layer only <strong>depends on the layer directly inside it</strong>. The most independent layer is shown in the most inner circle and it is the Domain Layer.</p> <h3 id="core-building-blocks"><a href="#core-building-blocks" class="header-anchor">#</a> Core Building Blocks</h3> <p>DDD mostly <strong>focuses on the Domain &amp; Application Layers</strong> and ignores the Presentation and Infrastructure. They are seen as <em>details</em> and the business layers should not depend on them.</p> <p>That doesn't mean the Presentation and Infrastructure layers are not important. They are very important. UI frameworks and database providers have their own rules and best practices that you need to know and apply. However these are not in the topics of DDD.</p> <p>This section introduces the essential building blocks of the Domain &amp; Application Layers.</p> <h4 id="domain-layer-building-blocks"><a href="#domain-layer-building-blocks" class="header-anchor">#</a> Domain Layer Building Blocks</h4> <ul><li><strong>Entity</strong>: An <a href="/blogs/2021/Abp/Entities.html">Entity</a> is an object with its own properties (state, data) and methods that implements the business logic that is executed on these properties. An entity is represented by its unique identifier (Id). Two entity object with different Ids are considered as different entities.</li> <li><strong>Value Object</strong>: A <a href="/blogs/2021/Abp/Value-Objects.html">Value Object</a> is another kind of domain object that is identified by its properties rather than a unique Id. That means two Value Objects with same properties are considered as the same object. Value objects are generally implemented as immutable and mostly are much simpler than the Entities.</li> <li><strong>Aggregate &amp; Aggregate Root</strong>: An <a href="/blogs/2021/Abp/Entities.html">Aggregate</a> is a cluster of objects (entities and value objects) bound together by an <strong>Aggregate Root</strong> object. The Aggregate Root is a specific type of an entity with some additional responsibilities.</li> <li><strong>Repository</strong> (interface): A <a href="/blogs/2021/Abp/Repositories.html">Repository</a> is a collection-like interface that is used by the Domain and Application Layers to access to the data persistence system (the database). It hides the complexity of the DBMS from the business code. Domain Layer contains the <code>interface</code>s of the repositories.</li> <li><strong>Domain Service</strong>: A <a href="/blogs/2021/Abp/Domain-Services.html">Domain Service</a> is a stateless service that implements core business rules of the domain. It is useful to implement domain logic that depends on multiple aggregate (entity) type or some external services.</li> <li><strong>Specification</strong>: A <a href="/blogs/2021/Abp/Specifications.html">Specification</a> is used to define named, reusable and combinable filters for entities and other business objects.</li> <li><strong>Domain Event</strong>: A <a href="/blogs/2021/Abp/Event-Bus.html">Domain Event</a> is a way of informing other services in a loosely coupled manner, when a domain specific event occurs.</li></ul> <h4 id="application-layer-building-blocks"><a href="#application-layer-building-blocks" class="header-anchor">#</a> Application Layer Building Blocks</h4> <ul><li><strong>Application Service</strong>: An <a href="/blogs/2021/Abp/Application-Services.html">Application Service</a> is a stateless service that implements use cases of the application. An application service typically gets and returns DTOs. It is used by the Presentation Layer. It uses and coordinates the domain objects to implement the use cases. A use case is typically considered as a Unit Of Work.</li> <li><strong>Data Transfer Object (DTO)</strong>: A <a href="/blogs/2021/Abp/Data-Transfer-Objects.html">DTO</a> is a simple object without any business logic that is used to transfer state (data) between the Application and Presentation Layers.</li> <li><strong>Unit of Work (UOW)</strong>: A <a href="/blogs/2021/Abp/Unit-Of-Work.html">Unit of Work</a> is an atomic work that should be done as a transaction unit. All the operations inside a UOW should be committed on success or rolled back on a failure.</li></ul> <h2 id="implementation-the-big-picture"><a href="#implementation-the-big-picture" class="header-anchor">#</a> Implementation: The Big Picture</h2> <h3 id="layering-of-a-net-solution"><a href="#layering-of-a-net-solution" class="header-anchor">#</a> Layering of a .NET Solution</h3> <p>The picture below shows a Visual Studio Solution created using the ABP's <a href="/blogs/2021/Abp/Startup-Templates/Application.html">application startup template</a>:</p> <p><img src="/assets/img/domain-driven-design-vs-solution.1e8b39de.png" alt="domain-driven-design-vs-solution"></p> <p>The solution name is <code>IssueTracking</code> and it consists of multiple projects. The solution is layered by considering <strong>DDD principles</strong> as well as <strong>development</strong> and <strong>deployment</strong> practicals. The sub sections below explains the projects in the solution;</p> <blockquote><p>Your solution structure may be slightly different if you choose a different UI or Database provider. However, the Domain and Application layers will be same and this is the essential point for the DDD perspective. See the <a href="/blogs/2021/Abp/Startup-Templates/Application.html">Application Startup Template</a> document if you want to know more about the solution structure.</p></blockquote> <h4 id="the-domain-layer"><a href="#the-domain-layer" class="header-anchor">#</a> The Domain Layer</h4> <p>The Domain Layer is splitted into two projects;</p> <ul><li><code>IssueTracking.Domain</code> is the <strong>essential domain layer</strong> that contains all the <strong>building blocks</strong> (entities, value objects, domain services, specifications, repository interfaces, etc.) introduced before.</li> <li><code>IssueTracking.Domain.Shared</code> is a thin project that contains some types those belong to the Domain Layer, but shared with all other layers. For example, it may contain some constants and <code>enum</code>s related to the Domain Objects but need to be <strong>reused by other layers</strong>.</li></ul> <h4 id="the-application-layer"><a href="#the-application-layer" class="header-anchor">#</a> The Application Layer</h4> <p>The Application Layer is also splitted into two projects;</p> <ul><li><code>IssueTracking.Application.Contracts</code> contains the application service <strong>interfaces</strong> and the <strong>DTO</strong>s used by these interfaces. This project can be shared by the client applications (including the UI).</li> <li><code>IssueTracking.Application</code> is the <strong>essential application layer</strong> that <strong>implements</strong> the interfaces defined in the Contracts project.</li></ul> <h4 id="the-presentation-layer"><a href="#the-presentation-layer" class="header-anchor">#</a> The Presentation Layer</h4> <ul><li><code>IssueTracking.Web</code> is an ASP.NET Core MVC / Razor Pages application for this example. This is the only executable application that serves the application and the APIs.</li></ul> <blockquote><p>ABP Framework also supports different kind of UI frameworks including <a href="/blogs/2021/Abp/UI/Angular/Quick-Start.html">Angular</a> and <a href="/blogs/2021/Abp/UI/Blazor/Overall.html">Blazor</a>. In these cases, the <code>IssueTracking.Web</code> doesn't exist in the solution. Instead, an <code>IssueTracking.HttpApi.Host</code> application will be in the solution to serve the HTTP APIs as a standalone endpoint to be consumed by the UI applications via HTTP API calls.</p></blockquote> <h4 id="the-remote-service-layer"><a href="#the-remote-service-layer" class="header-anchor">#</a> The Remote Service Layer</h4> <ul><li><code>IssueTracking.HttpApi</code> project contains HTTP APIs defined by the solution. It typically contains MVC <code>Controller</code>s and related models, if available. So, you write your HTTP APIs in this project.</li></ul> <blockquote><p>Most of the time, API Controllers are just wrappers around the Application Services to expose them to the remote clients. Since ABP Framework's <a href="/blogs/2021/Abp/API/Auto-API-Controllers.html">Automatic API Controller System</a> <strong>automatically configures and exposes your Application Services as API Controllers</strong>, you typically don't create Controllers in this project. However, the startup solution includes it for the cases you need to manually create API controllers.</p></blockquote> <ul><li><code>IssueTracking.HttpApi.Client</code> project is useful when you have a C# application that needs to consume your HTTP APIs. Once the client application references this project, it can directly <a href="/blogs/2021/Abp/Dependency-Injection.html">inject</a> &amp; use the Application Services. This is possible by the help of the ABP Framework's <a href="/blogs/2021/Abp/API/Dynamic-CSharp-API-Clients.html">Dynamic C# Client API Proxies System</a>.</li></ul> <blockquote><p>There is a Console Application in the <code>test</code> folder of the solution, named <code>IssueTracking.HttpApi.Client.ConsoleTestApp</code>. It simply uses the <code>IssueTracking.HttpApi.Client</code> project to consume the APIs exposed by the application. It is just a demo application and you can safely delete it. You can even delete the <code>IssueTracking.HttpApi.Client</code> project if you think that you don't need to them.</p></blockquote> <h4 id="the-infrastructure-layer"><a href="#the-infrastructure-layer" class="header-anchor">#</a> The Infrastructure Layer</h4> <p>In a DDD implementation, you may have a single Infrastructure project to implement all the abstractions and integrations, or you may have different projects for each dependency.</p> <p>We suggest a balanced approach; Create separate projects for main infrastructure dependencies (like Entity Framework Core) and a common infrastructure project for other infrastructure.</p> <p>ABP's startup solution has two projects for the Entity Framework Core integration;</p> <ul><li><code>IssueTracking.EntityFrameworkCore</code> is the essential integration package for the EF Core. Your application's <code>DbContext</code>, database mappings, implementations of the repositories and other EF Core related stuff are located here.</li> <li><code>IssueTracking.EntityFrameworkCore.DbMigrations</code> is a special project to manage the Code First database migrations. There is a separate <code>DbContext</code> in this project to track the migrations. You typically don't touch this project much except you need to create a new database migration or add an <a href="/blogs/2021/Abp/Modules/">application module</a> that has some database tables and naturally requires to create a new database migration.</li></ul> <blockquote><p>You may wonder why there are two projects for the EF Core. It is mostly related to <a href="/blogs/2021/Abp/Module-Development-Basics.html">modularity</a>. Each module has its own independent <code>DbContext</code> and your application has also one <code>DbContext</code>. <code>DbMigrations</code> project contains a <strong>union</strong> of the modules to track and apply a <strong>single migration path</strong>. While most of the time you don't need to know it, you can see the <a href="/blogs/2021/Abp/Entity-Framework-Core-Migrations.html">EF Core migrations</a> document for more information.</p></blockquote> <h4 id="other-projects"><a href="#other-projects" class="header-anchor">#</a> Other Projects</h4> <p>There is one more project, <code>IssueTracking.DbMigrator</code>, that is a simple Console Application that <strong>migrates</strong> the database schema and <strong><a href="/blogs/2021/Abp/Data-Seeding.html">seeds</a> the initial</strong> data when you execute it. It is a useful <strong>utility application</strong> that you can use it in development as well as in production environment.</p> <h3 id="dependencies-of-the-projects-in-the-solution"><a href="#dependencies-of-the-projects-in-the-solution" class="header-anchor">#</a> Dependencies of the Projects in the Solution</h3> <p>The diagram below shows the essential dependencies (project references) between the projects in the solution (<code>IssueTracking.</code> part is not shown to be simple)</p> <p><img src="/assets/img/domain-driven-design-project-relations.23f6943b.png" alt="domain-driven-design-project-relations"></p> <p>The projects have been explained before. Now, we can explain the reasons of the dependencies;</p> <ul><li><code>Domain.Shared</code> is the project that all other projects directly or indirectly depend on. So, all the types in this project are available to all projects.</li> <li><code>Domain</code> only depends on the <code>Domain.Shared</code> because it is already a (shared) part of the domain. For example, an <code>IssueType</code> enum in the <code>Domain.Shared</code> can be used by an <code>Issue</code> entity in the <code>Domain</code> project.</li> <li><code>Application.Contracts</code> depends on the <code>Domain.Shared</code>. In this way, you can reuse these types in the DTOs. For example, the same <code>IssueType</code> enum in the <code>Domain.Shared</code> can be used by a <code>CreateIssueDto</code> as a property.</li> <li><code>Application</code> depends on the <code>Application.Contracts</code> since it implements the Application Service interfaces and uses the DTOs inside it. It also depends on the <code>Domain</code> since the Application Services are implemented using the Domain Objects defined inside it.</li> <li><code>EntityFrameworkCore</code> depends on the <code>Domain</code> since it maps the Domain Objects (entities and value types) to database tables (as it is an ORM) and implements the repository interfaces defined in the <code>Domain</code>.</li> <li><code>HttpApi</code> depends on the <code>Application.Contacts</code> since the Controllers inside it inject and use the Application Service interfaces as explained before.</li> <li><code>HttpApi.Client</code> depends on the <code>Application.Contacts</code> since it can consume the Application Services as explained before.</li> <li><code>Web</code> depends on the <code>HttpApi</code> since it serves the HTTP APIs defined inside it. Also, in this way, it indirectly depends on the <code>Application.Contacts</code> project to consume the Application Services in the Pages/Components.</li></ul> <h4 id="dashed-dependencies"><a href="#dashed-dependencies" class="header-anchor">#</a> Dashed Dependencies</h4> <p>When you investigate the solution, you will see two more dependencies shown with the dashed lines in the figure above. <code>Web</code> project depends on the <code>Application</code> and <code>EntityFrameworkCore</code> projects which <em>theoretically</em> should not be like that but actually it is.</p> <p>This is because the <code>Web</code> is the final project that runs and hosts the application and the <strong>application needs the implementations of the Application Services and the Repositories</strong> while running.</p> <p>This design decision potentially allows you to use Entities and EF Core objects in the Presentation Layer which <strong>should be strictly avoided</strong>. However, we find the alternative designs over complicated. Here, two of the alternatives if you want to remove this dependency;</p> <ul><li>Convert <code>Web</code> project to a razor class library and create a new project, like <code>Web.Host</code>, that depends on the <code>Web</code>, <code>Application</code> and <code>EntityFrameworkCore</code> projects and hosts the application. You don't write any UI code here, but use <strong>only for hosting</strong>.</li> <li>Remove <code>Application</code> and <code>EntityFrameworkCore</code> dependencies from the <code>Web</code> project and load their assemblies on application initialization. You can use ABP's <a href="/blogs/2021/Abp/PlugIn-Modules.html">Plug-In Modules</a> system for that purpose.</li></ul> <h3 id="execution-flow-a-ddd-based-application"><a href="#execution-flow-a-ddd-based-application" class="header-anchor">#</a> Execution Flow a DDD Based Application</h3> <p>The figure below shows a typical request flow for a web application that has been developed based on DDD patterns.</p> <p><img src="/assets/img/domain-driven-design-web-request-flow.91433c89.png" alt=""></p> <ul><li>The request typically begins with a user interaction on the UI (a <em>use case</em>) that causes an HTTP request to the server.</li> <li>An MVC Controller or a Razor Page Handler in the Presentation Layer (or in the Distributed Services Layer) handles the request and can perform some cross cutting concerns in this stage (<a href="/blogs/2021/Abp/Authorization.html">Authorization</a>, <a href="/blogs/2021/Abp/Validation.html">Validation</a>, <a href="/blogs/2021/Abp/Exception-Handling.html">Exception Handling</a>, etc.). A Controller/Page injects the related Application Service interface and calls its method(s) by sending and receiving DTOs.</li> <li>The Application Service uses the Domain Objects (Entities, Repository interfaces, Domain Services, etc.) to implement the <em>use case</em>. Application Layer implements some cross cutting concerns (Authorization, Validation, etc.). An Application Service method should be a <a href="/blogs/2021/Abp/Unit-Of-Work.html">Unit Of Work</a>. That means it should be atomic.</li></ul> <p>Most of the cross cutting concerns are <strong>automatically and conventionally implemented by the ABP Framework</strong> and you typically don't need to write code for them.</p> <h3 id="common-principles"><a href="#common-principles" class="header-anchor">#</a> Common Principles</h3> <p>Before going into details, let's see some overall DDD principles;</p> <h4 id="database-provider-orm-independence"><a href="#database-provider-orm-independence" class="header-anchor">#</a> Database Provider / ORM Independence</h4> <p>The domain and the application layers should be ORM / Database Provider agnostic. They should only depend on the Repository interfaces and the Repository interfaces don't use any ORM specific objects.</p> <p>Here, the main reasons of this principle;</p> <ol><li>To make your domain/application <strong>infrastructure independent</strong> since the infrastructure may change in the future or you may need to support a second database type later.</li> <li>To make your domain/application <strong>focus on the business code</strong> by hiding the infrastructure details behind the repositories.</li> <li>To make your <strong>automated tests</strong> easier since you can mock the repositories in this case.</li></ol> <blockquote><p>As a respect to this principle, none of the projects in the solution has reference to the <code>EntityFrameworkCore</code> project, except the startup application.</p></blockquote> <h5 id="discussion-about-the-database-independence-principle"><a href="#discussion-about-the-database-independence-principle" class="header-anchor">#</a> Discussion About the Database Independence Principle</h5> <p>Especially, the <strong>reason 1</strong> deeply effects your domain <strong>object design</strong> (especially, the entity relations) and <strong>application code</strong>. Assume that you are using <a href="/blogs/2021/Abp/Entity-Framework-Core.html">Entity Framework Core</a> with a relational database. If you are willing to make your application switchable to <a href="/blogs/2021/Abp/MongoDB.html">MongoDB</a> later, you can't use some very <strong>useful EF Core features</strong>. Examples;</p> <ul><li>You can't assume <a href="https://docs.microsoft.com/en-us/ef/core/querying/tracking" target="_blank" rel="noopener noreferrer">Change Tracking<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> since MongoDB provider can't do it. So, you always need to explicitly update the changed entities.</li> <li>You can't use <a href="https://docs.microsoft.com/en-us/ef/core/modeling/relationships" target="_blank" rel="noopener noreferrer">Navigation Properties<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (or Collections) to other Aggregates in your entities since this is not possible for a Document Database. See the &quot;Rule: Reference Other Aggregates Only By Id&quot; section for more info.</li></ul> <p>If you think such features are <strong>important</strong> for you and you <strong>will never stray</strong> from the EF Core, we believe that it is worth <strong>stretching this principle</strong>. We still suggest to use the repository pattern to hide the infrastructure details. But you can assume that you are using EF Core while designing your entity relations and writing your application code. You can even reference to the EF Core NuGet Package from your application layer to be able to directly use the asynchronous LINQ extension methods, like <code>ToListAsync()</code> (see the <em>IQueryable &amp; Async Operations</em> section in the <a href="/blogs/2021/Abp/Repositories.html">Repositories</a> document for more info).</p> <h4 id="presentation-technology-agnostic"><a href="#presentation-technology-agnostic" class="header-anchor">#</a> Presentation Technology Agnostic</h4> <p>The presentation technology (UI Framework) is one of the most changed parts of a real world application. It is very important to design the <strong>Domain and Application Layers</strong> to be completely <strong>unaware</strong> of the presentation technology/framework. This principle is relatively easy to implement and ABP's startup template makes it even easier.</p> <p>In some cases, you may need to have <strong>duplicate logic</strong> in the application and presentation layers. For example, you may need to duplicate the <strong>validation</strong> and <strong>authorization</strong> checks in both layers. The checks in the UI layer is mostly for <strong>user experience</strong> while checks in the application and domain layers are for <strong>security and data integrity</strong>. That's perfectly normal and necessary.</p> <h4 id="focus-on-the-state-changes-not-reporting"><a href="#focus-on-the-state-changes-not-reporting" class="header-anchor">#</a> Focus on the State Changes, Not Reporting</h4> <p>DDD focuses on how the domain objects <strong>changes and interactions</strong>; How to create an entity and change its properties by preserving the data <strong>integrity/validity</strong> and implementing the <strong>business rules</strong>.</p> <p>DDD <strong>ignores reporting</strong> and mass querying. That doesn't mean they are not important. If your application doesn't have fancy dashboards and reports, who would use it? However, reporting is another topic. You typically want to use the full power of the SQL Server or even use a separate data source (like ElasticSearch) for reporting purpose. You will write optimized queries, create indexes and even stored procedures(!). You are free to do all these things as long as you don't infect them into your business logic.</p> <h2 id="implementation-the-building-blocks"><a href="#implementation-the-building-blocks" class="header-anchor">#</a> Implementation: The Building Blocks</h2> <p>This is the essential part of this guide. We will introduce and explain some <strong>explicit rules</strong> with examples. You can follow these rules and apply in your solution while implementing the Domain Driven Design.</p> <h3 id="the-example-domain"><a href="#the-example-domain" class="header-anchor">#</a> The Example Domain</h3> <p>The examples will use some concepts those are used by GitHub, like <code>Issue</code>, <code>Repository</code>, <code>Label</code> and <code>User</code>, you are already familiar with. The figure below shows some of the aggregates, aggregate roots, entities, value object and the relations between them:</p> <p><img src="/assets/img/domain-driven-design-example-domain-schema.00ec5050.png" alt="domain driven design example schema"></p> <p><strong>Issue Aggregate</strong> consists of an <code>Issue</code> Aggregate Root that contains <code>Comment</code> and <code>IssueLabel</code> collections. Other aggregates are shown as simple since we will focus on the Issue Aggregate:</p> <p><img src="/assets/img/domain-driven-design-issue-aggregate-diagram.058531d1.png" alt="domain-driven-design-issue-aggregate-diagram"></p> <h3 id="aggregates"><a href="#aggregates" class="header-anchor">#</a> Aggregates</h3> <p>As said before, an <a href="/blogs/2021/Abp/Entities.html">Aggregate</a> is a cluster of objects (entities and value objects) bound together by an Aggregate Root object. This section will introduce the principles and rules related to the Aggregates.</p> <blockquote><p>We refer the term <em>Entity</em> both for <em>Aggregate Root</em> and <em>sub-collection entities</em> unless we explicitly write <em>Aggregate Root</em> or <em>sub-collection entity</em>.</p></blockquote> <h4 id="aggregate-aggregate-root-principles"><a href="#aggregate-aggregate-root-principles" class="header-anchor">#</a> Aggregate / Aggregate Root Principles</h4> <h5 id="business-rules"><a href="#business-rules" class="header-anchor">#</a> Business Rules</h5> <p>Entities are responsible to implement the business rules related to the properties of their own. The <em>Aggregate Root Entities</em> are also responsible for their sub-collection entities.</p> <p>An aggregate should maintain its self <strong>integrity</strong> and <strong>validity</strong> by implementing domain rules and constraints. That means, unlike the DTOs, Entities have <strong>methods to implement some business logic</strong>. Actually, we should try to implement business rules in the entities wherever possible.</p> <h5 id="single-unit"><a href="#single-unit" class="header-anchor">#</a> Single Unit</h5> <p>An aggregate is <strong>retrieved and saved as a single unit</strong>, with all the sub-collections and properties. For example, if you want to add a <code>Comment</code> to an <code>Issue</code>, you need to;</p> <ul><li>Get the <code>Issue</code> from database with including all the sub-collections (<code>Comment</code>s and <code>IssueLabel</code>s).</li> <li>Use methods on the <code>Issue</code> class to add a new comment, like <code>Issue.AddComment(...);</code>.</li> <li>Save the <code>Issue</code> (with all sub-collections) to the database as a single database operation (update).</li></ul> <p>That may seem strange to the developers used to work with <strong>EF Core &amp; Relational Databases</strong> before. Getting the <code>Issue</code> with all details seems <strong>unnecessary and inefficient</strong>. Why don't we just execute an SQL <code>Insert</code> command to database without querying any data?</p> <p>The answer is that we should <strong>implement the business</strong> rules and preserve the data <strong>consistency</strong> and <strong>integrity</strong> in the <strong>code</strong>. If we have a business rule like &quot;<em>Users can not comment on the locked issues</em>&quot;, how can we check the <code>Issue</code>'s lock state without retrieving it from the database? So, we can execute the business rules only if the related objects available in the application code.</p> <p>On the other hand, <strong>MongoDB</strong> developers will find this rule very natural. In MongoDB, an aggregate object (with sub-collections) is saved in a <strong>single collection</strong> in the database (while it is distributed into several tables in a relational database). So, when you get an aggregate, all the sub-collections are already retrieved as a part of the query, without any additional configuration.</p> <p>ABP Framework helps to implement this principle in your applications.</p> <p><strong>Example: Add a comment to an issue</strong></p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IssueAppService</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ApplicationService</span><span class="token punctuation">,</span> <span class="token class-name">IIssueAppService</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IRepository<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">,</span> Guid<span class="token punctuation">&gt;</span></span> _issueRepository<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">IssueAppService</span><span class="token punctuation">(</span><span class="token class-name">IRepository<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">,</span> Guid<span class="token punctuation">&gt;</span></span> issueRepository<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _issueRepository <span class="token operator">=</span> issueRepository<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Authorize</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">CreateCommentAsync</span><span class="token punctuation">(</span><span class="token class-name">CreateCommentDto</span> input<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> issue <span class="token operator">=</span> <span class="token keyword">await</span> _issueRepository<span class="token punctuation">.</span><span class="token function">GetAsync</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>IssueId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        issue<span class="token punctuation">.</span><span class="token function">AddComment</span><span class="token punctuation">(</span>CurrentUser<span class="token punctuation">.</span><span class="token function">GetId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> input<span class="token punctuation">.</span>Text<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> _issueRepository<span class="token punctuation">.</span><span class="token function">UpdateAsync</span><span class="token punctuation">(</span>issue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><code>_issueRepository.GetAsync</code> method retrieves the <code>Issue</code> with all details (sub-collections) as a single unit by default. While this works out of the box for MongoDB, you need to configure your aggregate details for the EF Core. But, once you configure, repositories automatically handle it. <code>_issueRepository.GetAsync</code> method gets an optional parameter, <code>includeDetails</code>, that you can pass <code>false</code> to disable this behavior when you need it.</p> <blockquote><p>See the <em>Loading Related Entities</em> section of the <a href="/blogs/2021/Abp/Entity-Framework-Core.html">EF Core document</a> for the configuration and alternative scenarios.</p></blockquote> <p><code>Issue.AddComment</code> gets a <code>userId</code> and comment <code>text</code>, implements the necessary business rules and adds the comment to the Comments collection of the <code>Issue</code>.</p> <p>Finally, we use <code>_issueRepository.UpdateAsync</code> to save changes to the database.</p> <blockquote><p>EF Core has a <strong>change tracking</strong> feature. So, you actually don't need to call <code>_issueRepository.UpdateAsync</code>. It will be automatically saved thanks to ABP's Unit Of Work system that automatically calls <code>DbContext.SaveChanges()</code> at the end of the method. However, for MongoDB, you need to explicitly update the changed entity.</p> <p>So, if you want to write your code Database Provider independent, you should always call the <code>UpdateAsync</code> method for the changed entities.</p></blockquote> <h5 id="transaction-boundary"><a href="#transaction-boundary" class="header-anchor">#</a> Transaction Boundary</h5> <p>An aggregate is generally considered as a transaction boundary. If a use case works with a single aggregate, reads and saves it as a single unit, all the changes made to the aggregate objects are saved together as an atomic operation and you don't need to an explicit database transaction.</p> <p>However, in real life, you may need to change <strong>more than one aggregate instances</strong> in a single use case and you need to use database transactions to ensure <strong>atomic update</strong> and <strong>data consistency</strong>. Because of that, ABP Framework uses an explicit database transaction for a use case (an application service method boundary). See the <a href="/blogs/2021/Abp/Unit-Of-Work.html">Unit Of Work</a> documentation for more info.</p> <h5 id="serializability"><a href="#serializability" class="header-anchor">#</a> Serializability</h5> <p>An aggregate (with the root entity and sub-collections) should be serializable and transferrable on the wire as a single unit. For example, MongoDB serializes the aggregate to JSON document while saving to the database and deserializes from JSON while reading from the database.</p> <blockquote><p>This requirement is not necessary when you use relational databases and ORMs. However, it is an important practice of Domain Driven Design.</p></blockquote> <p>The following rules will already bring the serializability.</p> <h4 id="aggregate-aggregate-root-rules-best-practices"><a href="#aggregate-aggregate-root-rules-best-practices" class="header-anchor">#</a> Aggregate / Aggregate Root Rules &amp; Best Practices</h4> <p>The following rules ensures implementing the principles introduced above.</p> <h5 id="reference-other-aggregates-only-by-id"><a href="#reference-other-aggregates-only-by-id" class="header-anchor">#</a> Reference Other Aggregates Only By Id</h5> <p>The first rule says an Aggregate should reference to other aggregates only by their Id. That means you can not add navigation properties to other aggregates.</p> <ul><li>This rule makes it possible to implement the serializability principle.</li> <li>It also prevents different aggregates manipulate each other and leaking business logic of an aggregate to one another.</li></ul> <p>You see two aggregate roots, <code>GitRepository</code> and <code>Issue</code> in the example below;</p> <p><img src="/assets/img/domain-driven-design-reference-by-id-sample.af78deef.png" alt="domain-driven-design-reference-by-id-sample"></p> <ul><li><code>GitRepository</code> should not have a collection of the <code>Issue</code>s since they are different aggregates.</li> <li><code>Issue</code> should not have a navigation property for the related <code>GitRepository</code> since it is a different aggregate.</li> <li><code>Issue</code> can have <code>RepositoryId</code> (as a <code>Guid</code>).</li></ul> <p>So, when you have an <code>Issue</code> and need to have <code>GitRepository</code> related to this issue, you need to explicitly query it from database by the <code>RepositoryId</code>.</p> <h6 id="for-ef-core-relational-databases"><a href="#for-ef-core-relational-databases" class="header-anchor">#</a> For EF Core &amp; Relational Databases</h6> <p>In MongoDB, it is naturally not suitable to have such navigation properties/collections. If you do that, you find a copy of the destination aggregate object in the database collection of the source aggregate since it is being serialized to JSON on save.</p> <p>However, EF Core &amp; relational database developers may find this restrictive rule unnecessary since EF Core can handle it on database read and write. We see this an important rule that helps to <strong>reduce the complexity</strong> of the domain prevents potential problems and we strongly suggest to implement this rule. However, if you think it is practical to ignore this rule, see the <em>Discussion About the Database Independence Principle</em> section above.</p> <h5 id="keep-aggregates-small"><a href="#keep-aggregates-small" class="header-anchor">#</a> Keep Aggregates Small</h5> <p>One good practice is to keep an aggregate simple and small. This is because an aggregate will be loaded and saved as a single unit and reading/writing a big object has performance problems. See the example below:</p> <p><img src="/assets/img/domain-driven-design-aggregate-keep-small.1bd431c9.png" alt="domain-driven-design-aggregate-keep-small"></p> <p>Role aggregate has a collection of <code>UserRole</code> value objects to track the users assigned for this role. Notice that <code>UserRole</code> is not another aggregate and it is not a problem for the rule <em>Reference Other Aggregates Only By Id</em>. However, it is a problem in practical. A role may be assigned to thousands (even millions) of users in a real life scenario and it is a significant performance problem to load thousands of items whenever you query a <code>Role</code> from database (remember: Aggregates are loaded by their sub-collections as a single unit).</p> <p>On the other hand, <code>User</code> may have such a <code>Roles</code> collection since a user doesn't have much roles in practical and it can be useful to have a list of roles while you are working with a User Aggregate.</p> <p>If you think carefully, there is one more problem when Role and User both have the list of relation when use a <strong>non-relational database, like MongoDB</strong>. In this case, the same information is duplicated in different collections and it will be hard to maintain data consistency (whenever you add an item to <code>User.Roles</code>, you need to add it to <code>Role.Users</code> too).</p> <p>So, determine your aggregate boundaries and size based on the following considerations;</p> <ul><li>Objects used together.</li> <li>Query (load/save) performance and memory consumption.</li> <li>Data integrity, validity and consistency.</li></ul> <p>In practical;</p> <ul><li>Most of the aggregate roots will <strong>not have sub-collections</strong>.</li> <li>A sub-collection should not have more than <strong>100-150 items</strong> inside it at the most case. If you think a collection potentially can have more items, don't define the collection as a part of the aggregate and consider to extract another aggregate root for the entity inside the collection.</li></ul> <h5 id="primary-keys-of-the-aggregate-roots-entities"><a href="#primary-keys-of-the-aggregate-roots-entities" class="header-anchor">#</a> Primary Keys of the Aggregate Roots / Entities</h5> <ul><li>An aggregate root typically has a single <code>Id</code> property for its identifier (Primark Key: PK). We prefer <code>Guid</code> as the PK of an aggregate root entity (see the <a href="/blogs/2021/Abp/Guid-Generation.html">Guid Genertation document</a> to learn why).</li> <li>An entity (that's not the aggregate root) in an aggregate can use a composite primary key.</li></ul> <p>For example, see the Aggregate root and the Entity below:</p> <p><img src="/assets/img/domain-driven-design-entity-primary-keys.b038db61.png" alt="domain-driven-design-entity-primary-keys"></p> <ul><li><code>Organization</code> has a <code>Guid</code> identifier (<code>Id</code>).</li> <li><code>OrganizationUser</code> is a sub-collection of an <code>Organization</code> and has a composite primary key consists of the <code>OrganizationId</code> and <code>UserId</code>.</li></ul> <p>That doesn't mean sub-collection entities should always have composite PKs. They may have single <code>Id</code> properties when it's needed.</p> <blockquote><p>Composite PKs are actually a concept of relational databases since the sub-collection entities have their own tables and needs to a PK. On the other hand, for example, in MongoDB you don't need to define PK for the sub-collection entities at all since they are stored as a part of the aggregate root.</p></blockquote> <h5 id="constructors-of-the-aggregate-roots-entities"><a href="#constructors-of-the-aggregate-roots-entities" class="header-anchor">#</a> Constructors of the Aggregate Roots / Entities</h5> <p>The constructor is located where the lifecycle of an entity begins. There are a some responsibilities of a well designed constructor:</p> <ul><li>Gets the <strong>required entity properties</strong> as parameters to <strong>create a valid entity</strong>. Should force to pass only for the required parameters and may get non-required properties as optional parameters.</li> <li><strong>Checks validity</strong> of the parameters.</li> <li>Initializes <strong>sub-collections</strong>.</li></ul> <p><strong>Example: <code>Issue</code> (Aggregate Root) constructor</strong></p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>ObjectModel</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Volo<span class="token punctuation">.</span>Abp</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Volo<span class="token punctuation">.</span>Abp<span class="token punctuation">.</span>Domain<span class="token punctuation">.</span>Entities</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">IssueTracking<span class="token punctuation">.</span>Issues</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Issue</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">AggregateRoot<span class="token punctuation">&lt;</span>Guid<span class="token punctuation">&gt;</span></span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> RepositoryId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Title <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Text <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">Guid<span class="token punctuation">?</span></span> AssignedUserId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsClosed <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">IssueCloseReason<span class="token punctuation">?</span></span> CloseReason <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">//enum</span>

        <span class="token keyword">public</span> <span class="token return-type class-name">ICollection<span class="token punctuation">&lt;</span>IssueLabel<span class="token punctuation">&gt;</span></span> Labels <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token function">Issue</span><span class="token punctuation">(</span>
            <span class="token class-name">Guid</span> id<span class="token punctuation">,</span>
            <span class="token class-name">Guid</span> repositoryId<span class="token punctuation">,</span>
            <span class="token class-name"><span class="token keyword">string</span></span> title<span class="token punctuation">,</span>
            <span class="token class-name"><span class="token keyword">string</span></span> text <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
            <span class="token class-name">Guid<span class="token punctuation">?</span></span> assignedUserId <span class="token operator">=</span> <span class="token keyword">null</span>
            <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            RepositoryId <span class="token operator">=</span> repositoryId<span class="token punctuation">;</span>
            Title <span class="token operator">=</span> Check<span class="token punctuation">.</span><span class="token function">NotNullOrWhiteSpace</span><span class="token punctuation">(</span>title<span class="token punctuation">,</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>title<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            Text <span class="token operator">=</span> text<span class="token punctuation">;</span>
            AssignedUserId <span class="token operator">=</span> assignedUserId<span class="token punctuation">;</span>
            
            Labels <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Collection<span class="token punctuation">&lt;</span>IssueLabel<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token function">Issue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* for deserialization &amp; ORMs */</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><ul><li><code>Issue</code> class properly <strong>forces to create a valid entity</strong> by getting minimum required properties in its constructor as parameters.</li> <li>The constructor <strong>validates</strong> the inputs (<code>Check.NotNullOrWhiteSpace(...)</code> throws <code>ArgumentException</code> if the given value is empty).</li> <li>It <strong>initializes the sub-collections</strong>, so you don't get a null reference exception when you try to use the <code>Labels</code> collection after creating the <code>Issue</code>.</li> <li>The constructor also <strong>takes the <code>id</code></strong> and passes to the <code>base</code> class. We don't generate <code>Guid</code>s inside the constructor to be able to delegate this responsibility to another service (see <a href="/blogs/2021/Abp/Guid-Generation.html">Guid Generation</a>).</li> <li>Private <strong>empty constructor</strong> is necessary for ORMs. We made it <code>private</code> to prevent accidently using it in our own code.</li></ul> <blockquote><p>See the <a href="/blogs/2021/Abp/Entities.html">Entities</a> document to learn more about creating entities with the ABP Framework.</p></blockquote> <h5 id="entity-property-accessors-methods"><a href="#entity-property-accessors-methods" class="header-anchor">#</a> Entity Property Accessors &amp; Methods</h5> <p>The example above may seem strange to you! For example, we force to pass a non-null <code>Title</code> in the constructor. However, the developer may then set the <code>Title</code> property to <code>null</code> without any control. This is because the example code above just focuses on the constructor.</p> <p>If we declare all the properties with <strong>public setters</strong> (like the example <code>Issue</code> class above), we can't force <strong>validity</strong> and <strong>integrity</strong> of the entity in its lifecycle. So;</p> <ul><li>Use <strong>private setter</strong> for a property when you need to perform any <strong>logic</strong> while setting that property.</li> <li>Define public methods to manipulate such properties.</li></ul> <p><strong>Example: Methods to change the properties in a controlled way</strong></p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Volo<span class="token punctuation">.</span>Abp</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Volo<span class="token punctuation">.</span>Abp<span class="token punctuation">.</span>Domain<span class="token punctuation">.</span>Entities</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">IssueTracking<span class="token punctuation">.</span>Issues</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Issue</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">AggregateRoot<span class="token punctuation">&lt;</span>Guid<span class="token punctuation">&gt;</span></span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> RepositoryId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">//Never changes</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Title <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">//Needs validation</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Text <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">//No validation</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">Guid<span class="token punctuation">?</span></span> AssignedUserId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">//No validation</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsClosed <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">//Should be changed with CloseReason</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">IssueCloseReason<span class="token punctuation">?</span></span> CloseReason <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">//Should be changed with IsClosed</span>

        <span class="token comment">//...</span>

        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SetTitle</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> title<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            Title <span class="token operator">=</span> Check<span class="token punctuation">.</span><span class="token function">NotNullOrWhiteSpace</span><span class="token punctuation">(</span>title<span class="token punctuation">,</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>title<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Close</span><span class="token punctuation">(</span><span class="token class-name">IssueCloseReason</span> reason<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            IsClosed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            CloseReason <span class="token operator">=</span> reason<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ReOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            IsClosed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            CloseReason <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><ul><li><code>RepositoryId</code> setter made private and there is no way to change it after creating an <code>Issue</code> because this is what we want in this domain: An issue can't be moved to another repository.</li> <li><code>Title</code> setter made private and <code>SetTitle</code> method has been created if you want to change it later in a controlled way.</li> <li><code>Text</code> and <code>AssignedUserId</code> has public setters since there is no restriction on them. They can be null or any other value. We think it is unnecessary to define separate methods to set them. If we need later, we can add methods and make the setters private. Breaking changes are not problem in the domain layer since the domain layer is an internal project, it is not exposed to clients.</li> <li><code>IsClosed</code> and <code>IssueCloseReason</code> are pair properties. Defined <code>Close</code> and <code>ReOpen</code> methods to change them together. In this way, we prevent to close an issue without any reason.</li></ul> <h5 id="business-logic-exceptions-in-the-entities"><a href="#business-logic-exceptions-in-the-entities" class="header-anchor">#</a> Business Logic &amp; Exceptions in the Entities</h5> <p>When you implement validation and business logic in the entities, you frequently need to manage the exceptional cases. In these cases;</p> <ul><li>Create <strong>domain specific exceptions</strong>.</li> <li><strong>Throw these exceptions</strong> in the entity methods when necessary.</li></ul> <p><strong>Example</strong></p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Issue</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">AggregateRoot<span class="token punctuation">&lt;</span>Guid<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token comment">//...</span>
    
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsLocked <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsClosed <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">IssueCloseReason<span class="token punctuation">?</span></span> CloseReason <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Close</span><span class="token punctuation">(</span><span class="token class-name">IssueCloseReason</span> reason<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        IsClosed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        CloseReason <span class="token operator">=</span> reason<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ReOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>IsLocked<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">IssueStateException</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Can not open a locked issue! Unlock it first.&quot;</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        IsClosed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        CloseReason <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>IsClosed<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">IssueStateException</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Can not open a locked issue! Unlock it first.&quot;</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        IsLocked <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        IsLocked <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>There are two business rules here;</p> <ul><li>A locked issue can not be re-opened.</li> <li>You can not lock an open issue.</li></ul> <p><code>Issue</code> class throws an <code>IssueStateException</code> in these cases to force the business rules:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">IssueTracking<span class="token punctuation">.</span>Issues</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IssueStateException</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Exception</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token function">IssueStateException</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> message<span class="token punctuation">)</span>
            <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>There are two potential problems of throwing such exceptions;</p> <ol><li>In case of such an exception, should the <strong>end user</strong> see the exception (error) message? If so, how do you <strong>localize</strong> the exception message? You can not use the <a href="/blogs/2021/Abp/Localization.html">localization</a> system, because you can't inject and use <code>IStringLocalizer</code> in the entities.</li> <li>For a web application or HTTP API, what <strong>HTTP Status Code</strong> should return to the client?</li></ol> <p>ABP's <a href="/blogs/2021/Abp/Exception-Handling.html">Exception Handling</a> system solves these and similar problems.</p> <p><strong>Example: Throwing a business exception with code</strong></p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">Volo<span class="token punctuation">.</span>Abp</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">IssueTracking<span class="token punctuation">.</span>Issues</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IssueStateException</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">BusinessException</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token function">IssueStateException</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> code<span class="token punctuation">)</span>
            <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li><code>IssueStateException</code> class inherits the <code>BusinessException</code> class. ABP returns 403 (forbidden) HTTP Status code by default (instead of 500 - Internal Server Error) for the exceptions derived from the <code>BusinessException</code>.</li> <li>The <code>code</code> is used as a key in the localization resource file to find the localized message.</li></ul> <p>Now, we can change the <code>ReOpen</code> method as shown below:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ReOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>IsLocked<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">IssueStateException</span><span class="token punctuation">(</span><span class="token string">&quot;IssueTracking:CanNotOpenLockedIssue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    IsClosed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    CloseReason <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><blockquote><p>Use constants instead of magic strings.</p></blockquote> <p>And add an entry to the localization resource like below:</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;IssueTracking:CanNotOpenLockedIssue&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Can not open a locked issue! Unlock it first.&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>When you throw the exception, ABP automatically uses this localized message (based on the current language) to show to the end user.</li> <li>The exception code (<code>IssueTracking:CanNotOpenLockedIssue</code> here) is also sent to the client, so it may handle the error case programmatically.</li></ul> <blockquote><p>For this example, you could directly throw <code>BusinessException</code> instead of defining a specialized <code>IssueStateException</code>. The result will be same. See the <a href="/blogs/2021/Abp/Exception-Handling.html">exception handling document</a> for all the details.</p></blockquote> <h5 id="business-logic-in-entities-requiring-external-services"><a href="#business-logic-in-entities-requiring-external-services" class="header-anchor">#</a> Business Logic in Entities Requiring External Services</h5> <p>It is simple to implement a business rule in an entity method when the business logic only uses the properties of that entity. What if the business logic requires to <strong>query database</strong> or <strong>use any external services</strong> that should be resolved from the <a href="/blogs/2021/Abp/Dependency-Injection.html">dependency injection</a> system. Remember; <strong>Entities can not inject services!</strong></p> <p>There are two common ways of implementing such a business logic:</p> <ul><li>Implement the business logic on an entity method and <strong>get external dependencies as parameters</strong> of the method.</li> <li>Create a <strong>Domain Service</strong>.</li></ul> <p>Domain Services will be explained later. But, now let's see how it can be implemented in the entity class.</p> <p><strong>Example: Business Rule: Can not assign more than 3 open issues to a user concurrently</strong></p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Issue</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">AggregateRoot<span class="token punctuation">&lt;</span>Guid<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token comment">//...</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid<span class="token punctuation">?</span></span> AssignedUserId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">AssignToAsync</span><span class="token punctuation">(</span><span class="token class-name">AppUser</span> user<span class="token punctuation">,</span> <span class="token class-name">IUserIssueService</span> userIssueService<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> openIssueCount <span class="token operator">=</span> <span class="token keyword">await</span> userIssueService<span class="token punctuation">.</span><span class="token function">GetOpenIssueCountAsync</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>openIssueCount <span class="token operator">&gt;=</span> <span class="token number">3</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">BusinessException</span><span class="token punctuation">(</span><span class="token string">&quot;IssueTracking:ConcurrentOpenIssueLimit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        AssignedUserId <span class="token operator">=</span> user<span class="token punctuation">.</span>Id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">CleanAssignment</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        AssignedUserId <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><ul><li><code>AssignedUserId</code> property setter made private. So, the only way to change it to use the <code>AssignToAsync</code> and <code>CleanAssignment</code> methods.</li> <li><code>AssignToAsync</code> gets an <code>AppUser</code> entity. Actually, it only uses the <code>user.Id</code>, so you could get a <code>Guid</code> value, like <code>userId</code>. However, this way ensures that the <code>Guid</code> value is <code>Id</code> of an existing user and not a random <code>Guid</code> value.</li> <li><code>IUserIssueService</code> is an arbitrary service that is used to get open issue count for a user. It's the responsibility of the code part (that calls the <code>AssignToAsync</code>) to resolve the <code>IUserIssueService</code> and pass here.</li> <li><code>AssignToAsync</code> throws exception if the business rule doesn't meet.</li> <li>Finally, if everything is correct, <code>AssignedUserId</code> property is set.</li></ul> <p>This method perfectly guarantees to apply the business logic when you want to assign an issue to a user. However, it has some problems;</p> <ul><li>It makes the entity class <strong>depending on an external service</strong> which makes the entity <strong>complicated</strong>.</li> <li>It makes <strong>hard to use</strong> the entity. The code that uses the entity now needs to inject <code>IUserIssueService</code> and pass to the <code>AssignToAsync</code> method.</li></ul> <p>An alternative way of implementing this business logic is to introduce a <strong>Domain Service</strong>, which will be explained later.</p> <h3 id="repositories"><a href="#repositories" class="header-anchor">#</a> Repositories</h3> <p>A <a href="/blogs/2021/Abp/Repositories.html">Repository</a> is a collection-like interface that is used by the Domain and Application Layers to access to the data persistence system (the database) to read and write the Business Objects, generally the Aggregates.</p> <p>Common Repository principles are;</p> <ul><li>Define a repository <strong>interface in the Domain Layer</strong> (because it is used in the Domain and Application Layers), <strong>implement in the Infrastructure Layer</strong> (<em>EntityFrameworkCore</em> project in the startup template).</li> <li><strong>Do not include business logic</strong> inside the repositories.</li> <li>Repository interface should be <strong>database provider / ORM independent</strong>. For example, do not return a <code>DbSet</code> from a repository method. <code>DbSet</code> is an object provided by the EF Core.</li> <li><strong>Create repositories for aggregate roots</strong>, not for all entities. Because, sub-collection entities (of an aggregate) should be accessed over the aggregate root.</li></ul> <h4 id="do-not-include-domain-logic-in-repositories"><a href="#do-not-include-domain-logic-in-repositories" class="header-anchor">#</a> Do Not Include Domain Logic in Repositories</h4> <p>While this rule seems obvious at the beginning, it is easy to leak business logic into repositories.</p> <p><strong>Example: Get inactive issues from a repository</strong></p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Volo<span class="token punctuation">.</span>Abp<span class="token punctuation">.</span>Domain<span class="token punctuation">.</span>Repositories</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">IssueTracking<span class="token punctuation">.</span>Issues</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IIssueRepository</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IRepository<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">,</span> Guid<span class="token punctuation">&gt;</span></span></span>
    <span class="token punctuation">{</span>
        <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetInActiveIssuesAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><code>IIssueRepository</code> extends the standard <code>IRepository&lt;...&gt;</code> interface by adding a <code>GetInActiveIssuesAsync</code> method. This repository works with such an <code>Issue</code> class:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Issue</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">AggregateRoot<span class="token punctuation">&lt;</span>Guid<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">IHasCreationTime</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsClosed <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid<span class="token punctuation">?</span></span> AssignedUserId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> CreationTime <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime<span class="token punctuation">?</span></span> LastCommentTime <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token comment">//...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>(the code shows only the properties we need for this example)</p> <p>The rule says the repository shouldn't know the business rules. The question here is &quot;<strong>What is an inactive issue</strong>? Is it a business rule definition?&quot;</p> <p>Let's see the implementation to understand it:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Linq</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">IssueTracking<span class="token punctuation">.</span>EntityFrameworkCore</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>EntityFrameworkCore</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Volo<span class="token punctuation">.</span>Abp<span class="token punctuation">.</span>Domain<span class="token punctuation">.</span>Repositories<span class="token punctuation">.</span>EntityFrameworkCore</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Volo<span class="token punctuation">.</span>Abp<span class="token punctuation">.</span>EntityFrameworkCore</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">IssueTracking<span class="token punctuation">.</span>Issues</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EfCoreIssueRepository</span> <span class="token punctuation">:</span> 
        <span class="token type-list"><span class="token class-name">EfCoreRepository<span class="token punctuation">&lt;</span>IssueTrackingDbContext<span class="token punctuation">,</span> Issue<span class="token punctuation">,</span> Guid<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span>
        <span class="token class-name">IIssueRepository</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token function">EfCoreIssueRepository</span><span class="token punctuation">(</span>
            <span class="token class-name">IDbContextProvider<span class="token punctuation">&lt;</span>IssueTrackingDbContext<span class="token punctuation">&gt;</span></span> dbContextProvider<span class="token punctuation">)</span> 
            <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>dbContextProvider<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetInActiveIssuesAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> daysAgo30 <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">Subtract</span><span class="token punctuation">(</span>TimeSpan<span class="token punctuation">.</span><span class="token function">FromDays</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> dbSet <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">GetDbSetAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">await</span> dbSet<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>i <span class="token operator">=&gt;</span>

                <span class="token comment">//Open</span>
                <span class="token operator">!</span>i<span class="token punctuation">.</span>IsClosed <span class="token operator">&amp;&amp;</span>

                <span class="token comment">//Assigned to nobody</span>
                i<span class="token punctuation">.</span>AssignedUserId <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>

                <span class="token comment">//Created 30+ days ago</span>
                i<span class="token punctuation">.</span>CreationTime <span class="token operator">&lt;</span> daysAgo30 <span class="token operator">&amp;&amp;</span>

                <span class="token comment">//No comment or the last comment was 30+ days ago</span>
                <span class="token punctuation">(</span>i<span class="token punctuation">.</span>LastCommentTime <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> i<span class="token punctuation">.</span>LastCommentTime <span class="token operator">&lt;</span> daysAgo30<span class="token punctuation">)</span>

            <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToListAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>(Used EF Core for the implementation. See the <a href="/blogs/2021/Abp/Entity-Framework-Core.html">EF Core integration document</a> to learn how to create custom repositories with the EF Core.)</p> <p>When we check the <code>GetInActiveIssuesAsync</code> implementation, we see a <strong>business rule that defines an in-active issue</strong>: The issue should be <strong>open</strong>, <strong>assigned to nobody</strong>, <strong>created 30+ days ago</strong> and has <strong>no comment in the last 30 days</strong>.</p> <p>This is an implicit definition of a business rule that is hidden inside a repository method. The problem occurs when we need to reuse this business logic.</p> <p>For example, let's say that we want to add an <code>bool IsInActive()</code> method on the <code>Issue</code> entity. In this way, we can check activeness when we have an issue entity.</p> <p>Let's see the implementation:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Issue</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">AggregateRoot<span class="token punctuation">&lt;</span>Guid<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">IHasCreationTime</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsClosed <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid<span class="token punctuation">?</span></span> AssignedUserId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> CreationTime <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime<span class="token punctuation">?</span></span> LastCommentTime <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token comment">//...</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">IsInActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> daysAgo30 <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">Subtract</span><span class="token punctuation">(</span>TimeSpan<span class="token punctuation">.</span><span class="token function">FromDays</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span>
            <span class="token comment">//Open</span>
            <span class="token operator">!</span>IsClosed <span class="token operator">&amp;&amp;</span>

            <span class="token comment">//Assigned to nobody</span>
            AssignedUserId <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>

            <span class="token comment">//Created 30+ days ago</span>
            CreationTime <span class="token operator">&lt;</span> daysAgo30 <span class="token operator">&amp;&amp;</span>

            <span class="token comment">//No comment or the last comment was 30+ days ago</span>
            <span class="token punctuation">(</span>LastCommentTime <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> LastCommentTime <span class="token operator">&lt;</span> daysAgo30<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>We had to copy/paste/modify the code. What if the definition of the activeness changes? We should not forget to update both places. This is a duplication of a business logic, which is pretty dangerous.</p> <p>A good solution to this problem is the <em>Specification Pattern</em>!</p> <h3 id="specifications"><a href="#specifications" class="header-anchor">#</a> Specifications</h3> <p>A <a href="/blogs/2021/Abp/Specifications.html">specification</a> is a <strong>named</strong>, <strong>reusable</strong>, <strong>combinable</strong> and <strong>testable</strong> class to filter the Domain Objects based on the business rules.</p> <p>ABP Framework provides necessary infrastructure to easily create specification classes and use them inside your application code. Let's implement the in-active issue filter as a specification class:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Linq<span class="token punctuation">.</span>Expressions</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Volo<span class="token punctuation">.</span>Abp<span class="token punctuation">.</span>Specifications</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">IssueTracking<span class="token punctuation">.</span>Issues</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InActiveIssueSpecification</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Specification<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">&gt;</span></span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">ToExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> daysAgo30 <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">Subtract</span><span class="token punctuation">(</span>TimeSpan<span class="token punctuation">.</span><span class="token function">FromDays</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> i <span class="token operator">=&gt;</span>

                <span class="token comment">//Open</span>
                <span class="token operator">!</span>i<span class="token punctuation">.</span>IsClosed <span class="token operator">&amp;&amp;</span>

                <span class="token comment">//Assigned to nobody</span>
                i<span class="token punctuation">.</span>AssignedUserId <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>

                <span class="token comment">//Created 30+ days ago</span>
                i<span class="token punctuation">.</span>CreationTime <span class="token operator">&lt;</span> daysAgo30 <span class="token operator">&amp;&amp;</span>

                <span class="token comment">//No comment or the last comment was 30+ days ago</span>
                <span class="token punctuation">(</span>i<span class="token punctuation">.</span>LastCommentTime <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> i<span class="token punctuation">.</span>LastCommentTime <span class="token operator">&lt;</span> daysAgo30<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p><code>Specification&lt;T&gt;</code> base class simplifies to create a specification class by defining an expression. Just moved the expression here, from the repository.</p> <p>Now, we can re-use the <code>InActiveIssueSpecification</code> in the <code>Issue</code> entity and <code>EfCoreIssueRepository</code> classes.</p> <h4 id="using-within-the-entity"><a href="#using-within-the-entity" class="header-anchor">#</a> Using within the Entity</h4> <p><code>Specification</code> class provides an <code>IsSatisfiedBy</code> method that returns <code>true</code> if the given object (entity) satisfies the specification. We can re-write the <code>Issue.IsInActive</code> method as shown below:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Issue</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">AggregateRoot<span class="token punctuation">&lt;</span>Guid<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">IHasCreationTime</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsClosed <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid<span class="token punctuation">?</span></span> AssignedUserId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> CreationTime <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime<span class="token punctuation">?</span></span> LastCommentTime <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token comment">//...</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">IsInActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">InActiveIssueSpecification</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsSatisfiedBy</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>Just created a new instance of the <code>InActiveIssueSpecification</code> and used its <code>IsSatisfiedBy</code> method to re-use the expression defined by the specification.</p> <h4 id="using-with-the-repositories"><a href="#using-with-the-repositories" class="header-anchor">#</a> Using with the Repositories</h4> <p>First, starting from the repository interface:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IIssueRepository</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IRepository<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">,</span> Guid<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetIssuesAsync</span><span class="token punctuation">(</span><span class="token class-name">ISpecification<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">&gt;</span></span> spec<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>Renamed <code>GetInActiveIssuesAsync</code> to simple <code>GetIssuesAsync</code> by taking a specification object. Since the <strong>specification (the filter) has been moved out of the repository</strong>, we no longer need to create different methods to get issues with different conditions (like <code>GetAssignedIssues(...)</code>, <code>GetLockedIssues(...)</code>, etc.)</p> <p>Updated implementation of the repository can be like that:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EfCoreIssueRepository</span> <span class="token punctuation">:</span>
    <span class="token type-list"><span class="token class-name">EfCoreRepository<span class="token punctuation">&lt;</span>IssueTrackingDbContext<span class="token punctuation">,</span> Issue<span class="token punctuation">,</span> Guid<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span>
    <span class="token class-name">IIssueRepository</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">EfCoreIssueRepository</span><span class="token punctuation">(</span>
        <span class="token class-name">IDbContextProvider<span class="token punctuation">&lt;</span>IssueTrackingDbContext<span class="token punctuation">&gt;</span></span> dbContextProvider<span class="token punctuation">)</span>
        <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>dbContextProvider<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetIssuesAsync</span><span class="token punctuation">(</span><span class="token class-name">ISpecification<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">&gt;</span></span> spec<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> dbSet <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">GetDbSetAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> dbSet
            <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>spec<span class="token punctuation">.</span><span class="token function">ToExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">ToListAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>Since <code>ToExpression()</code> method returns an expression, it can be directly passed to the <code>Where</code> method to filter the entities.</p> <p>Finally, we can pass any Specification instance to the <code>GetIssuesAsync</code> method:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IssueAppService</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ApplicationService</span><span class="token punctuation">,</span> <span class="token class-name">IIssueAppService</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IIssueRepository</span> _issueRepository<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">IssueAppService</span><span class="token punctuation">(</span><span class="token class-name">IIssueRepository</span> issueRepository<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _issueRepository <span class="token operator">=</span> issueRepository<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">DoItAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> issues <span class="token operator">=</span> <span class="token keyword">await</span> _issueRepository<span class="token punctuation">.</span><span class="token function">GetIssuesAsync</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token constructor-invocation class-name">InActiveIssueSpecification</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h5 id="with-default-repositories"><a href="#with-default-repositories" class="header-anchor">#</a> With Default Repositories</h5> <p>Actually, you don't have to create custom repositories to be able to use specifications. The standard <code>IRepository</code> already extends the <code>IQueryable</code>, so you can use the standard LINQ extension methods over it:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IssueAppService</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ApplicationService</span><span class="token punctuation">,</span> <span class="token class-name">IIssueAppService</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IRepository<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">,</span> Guid<span class="token punctuation">&gt;</span></span> _issueRepository<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">IssueAppService</span><span class="token punctuation">(</span><span class="token class-name">IRepository<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">,</span> Guid<span class="token punctuation">&gt;</span></span> issueRepository<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _issueRepository <span class="token operator">=</span> issueRepository<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">DoItAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> queryable <span class="token operator">=</span> <span class="token keyword">await</span> _issueRepository<span class="token punctuation">.</span><span class="token function">GetQueryableAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> issues <span class="token operator">=</span> AsyncExecuter<span class="token punctuation">.</span><span class="token function">ToListAsync</span><span class="token punctuation">(</span>
            queryable<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">InActiveIssueSpecification</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><code>AsyncExecuter</code> is a utility provided by the ABP Framework to use asynchronous LINQ extension methods (like <code>ToListAsync</code> here) without depending on the EF Core NuGet package. See the <a href="/blogs/2021/Abp/Repositories.html">Repositories document</a> for more information.</p> <h4 id="combining-the-specifications"><a href="#combining-the-specifications" class="header-anchor">#</a> Combining the Specifications</h4> <p>One powerful side of the Specifications is they are combinable. Assume that we have another specification that returns <code>true</code> only if the <code>Issue</code> is in a Milestone:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MilestoneSpecification</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Specification<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> MilestoneId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">MilestoneSpecification</span><span class="token punctuation">(</span><span class="token class-name">Guid</span> milestoneId<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        MilestoneId <span class="token operator">=</span> milestoneId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name">Expression<span class="token punctuation">&lt;</span>Func<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">ToExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> i <span class="token operator">=&gt;</span> i<span class="token punctuation">.</span>MilestoneId <span class="token operator">==</span> MilestoneId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>This Specification is <em>parametric</em> as a difference from the <code>InActiveIssueSpecification</code>. We can combine both specifications to get a list of inactive issues in a specific milestone:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IssueAppService</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ApplicationService</span><span class="token punctuation">,</span> <span class="token class-name">IIssueAppService</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IRepository<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">,</span> Guid<span class="token punctuation">&gt;</span></span> _issueRepository<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">IssueAppService</span><span class="token punctuation">(</span><span class="token class-name">IRepository<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">,</span> Guid<span class="token punctuation">&gt;</span></span> issueRepository<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _issueRepository <span class="token operator">=</span> issueRepository<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">DoItAsync</span><span class="token punctuation">(</span><span class="token class-name">Guid</span> milestoneId<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> queryable <span class="token operator">=</span> <span class="token keyword">await</span> _issueRepository<span class="token punctuation">.</span><span class="token function">GetQueryableAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> issues <span class="token operator">=</span> AsyncExecuter<span class="token punctuation">.</span><span class="token function">ToListAsync</span><span class="token punctuation">(</span>
            queryable
                <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>
                    <span class="token keyword">new</span> <span class="token constructor-invocation class-name">InActiveIssueSpecification</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">And</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">MilestoneSpecification</span><span class="token punctuation">(</span>milestoneId<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">ToExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>The example above uses the <code>And</code> extension method to combine the specifications. There are more combining methods are available, like <code>Or(...)</code> and <code>AndNot(...)</code>.</p> <blockquote><p>See the <a href="/blogs/2021/Abp/Specifications.html">Specifications document</a> for more details about the specification infrastructure provided by the ABP Framework.</p></blockquote> <h3 id="domain-services"><a href="#domain-services" class="header-anchor">#</a> Domain Services</h3> <p>Domain Services implement domain logic which;</p> <ul><li>Depends on <strong>services and repositories</strong>.</li> <li>Needs to work with <strong>multiple aggregates</strong>, so the logic doesn't properly fit in any of the aggregates.</li></ul> <p>Domain Services work with Domain Objects. Their methods can <strong>get and return entities, value objects, primitive types</strong>... etc. However, <strong>they don't get/return DTOs</strong>. DTOs is a part of the Application Layer.</p> <p><strong>Example: Assigning an issue to a user</strong></p> <p>Remember how an issue assignment has been implemented in the <code>Issue</code> entity:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Issue</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">AggregateRoot<span class="token punctuation">&lt;</span>Guid<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token comment">//...</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid<span class="token punctuation">?</span></span> AssignedUserId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">AssignToAsync</span><span class="token punctuation">(</span><span class="token class-name">AppUser</span> user<span class="token punctuation">,</span> <span class="token class-name">IUserIssueService</span> userIssueService<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> openIssueCount <span class="token operator">=</span> <span class="token keyword">await</span> userIssueService<span class="token punctuation">.</span><span class="token function">GetOpenIssueCountAsync</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>openIssueCount <span class="token operator">&gt;=</span> <span class="token number">3</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">BusinessException</span><span class="token punctuation">(</span><span class="token string">&quot;IssueTracking:ConcurrentOpenIssueLimit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        AssignedUserId <span class="token operator">=</span> user<span class="token punctuation">.</span>Id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">CleanAssignment</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        AssignedUserId <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>Here, we will move this logic into a Domain Service.</p> <p>First, changing the <code>Issue</code> class:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Issue</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">AggregateRoot<span class="token punctuation">&lt;</span>Guid<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token comment">//...</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid<span class="token punctuation">?</span></span> AssignedUserId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">internal</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>Removed the assign-related methods.</li> <li>Changed <code>AssignedUserId</code> property's setter from <code>private</code> to <code>internal</code>, to allow to set it from the Domain Service.</li></ul> <p>The next step is to create a domain service, named <code>IssueManager</code>, that has <code>AssignToAsync</code> to assign the given issue to the given user.</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IssueManager</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">DomainService</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IRepository<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">,</span> Guid<span class="token punctuation">&gt;</span></span> _issueRepository<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">IssueManager</span><span class="token punctuation">(</span><span class="token class-name">IRepository<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">,</span> Guid<span class="token punctuation">&gt;</span></span> issueRepository<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _issueRepository <span class="token operator">=</span> issueRepository<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">AssignToAsync</span><span class="token punctuation">(</span><span class="token class-name">Issue</span> issue<span class="token punctuation">,</span> <span class="token class-name">AppUser</span> user<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> openIssueCount <span class="token operator">=</span> <span class="token keyword">await</span> _issueRepository<span class="token punctuation">.</span><span class="token function">CountAsync</span><span class="token punctuation">(</span>
            i <span class="token operator">=&gt;</span> i<span class="token punctuation">.</span>AssignedUserId <span class="token operator">==</span> user<span class="token punctuation">.</span>Id <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>i<span class="token punctuation">.</span>IsClosed
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>openIssueCount <span class="token operator">&gt;=</span> <span class="token number">3</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">BusinessException</span><span class="token punctuation">(</span><span class="token string">&quot;IssueTracking:ConcurrentOpenIssueLimit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        issue<span class="token punctuation">.</span>AssignedUserId <span class="token operator">=</span> user<span class="token punctuation">.</span>Id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p><code>IssueManager</code> can inject any service dependency and use to query open issue count on the user.</p> <blockquote><p>We prefer and suggest to use the <code>Manager</code> suffix for the Domain Services.</p></blockquote> <p>The only problem of this design is that <code>Issue.AssignedUserId</code> is now open to set out of the class. However, it is not <code>public</code>. It is <code>internal</code> and changing it is possible only inside the same Assembly, the <code>IssueTracking.Domain</code> project for this example solution. We think this is reasonable;</p> <ul><li>Domain Layer developers are already aware of domain rules and they use the <code>IssueManager</code>.</li> <li>Application Layer developers are already forces to use the <code>IssueManager</code> since they don't directly set it.</li></ul> <p>While there is a tradeoff between two approaches, we prefer to create Domain Services when the business logic requires to work with external services.</p> <blockquote><p>If you don't have a good reason, we think <strong>there is no need to create interfaces</strong> (like <code>IIssueManager</code> for the <code>IssueManager</code>) for Domain Services.</p></blockquote> <h3 id="application-services"><a href="#application-services" class="header-anchor">#</a> Application Services</h3> <p>An <a href="/blogs/2021/Abp/Application-Services.html">Application Service</a> is a stateless service that implements <strong>use cases</strong> of the application. An application service typically <strong>gets and returns DTOs</strong>. It is used by the Presentation Layer. It <strong>uses and coordinates the domain objects</strong> (entities, repositories, etc.) to implement the use cases.</p> <p>Common principles of an application service are;</p> <ul><li>Implement the <strong>application logic</strong> that is specific to the current use-case. Do not implement the core domain logic inside the application services. We will come back to differences between Application  Domain logics.</li> <li><strong>Never get or return entities</strong> for an application service method. This breaks the encapsulation of the Domain Layer. Always get and return DTOs.</li></ul> <p><strong>Example: Assign an Issue to a User</strong></p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">IssueTracking<span class="token punctuation">.</span>Users</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Authorization</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Volo<span class="token punctuation">.</span>Abp<span class="token punctuation">.</span>Application<span class="token punctuation">.</span>Services</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Volo<span class="token punctuation">.</span>Abp<span class="token punctuation">.</span>Domain<span class="token punctuation">.</span>Repositories</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">IssueTracking<span class="token punctuation">.</span>Issues</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IssueAppService</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ApplicationService</span><span class="token punctuation">,</span> <span class="token class-name">IIssueAppService</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IssueManager</span> _issueManager<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IRepository<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">,</span> Guid<span class="token punctuation">&gt;</span></span> _issueRepository<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IRepository<span class="token punctuation">&lt;</span>AppUser<span class="token punctuation">,</span> Guid<span class="token punctuation">&gt;</span></span> _userRepository<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token function">IssueAppService</span><span class="token punctuation">(</span>
            <span class="token class-name">IssueManager</span> issueManager<span class="token punctuation">,</span>
            <span class="token class-name">IRepository<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">,</span> Guid<span class="token punctuation">&gt;</span></span> issueRepository<span class="token punctuation">,</span>
            <span class="token class-name">IRepository<span class="token punctuation">&lt;</span>AppUser<span class="token punctuation">,</span> Guid<span class="token punctuation">&gt;</span></span> userRepository<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            _issueManager <span class="token operator">=</span> issueManager<span class="token punctuation">;</span>
            _issueRepository <span class="token operator">=</span> issueRepository<span class="token punctuation">;</span>
            _userRepository <span class="token operator">=</span> userRepository<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Authorize</span></span><span class="token punctuation">]</span>
        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">AssignAsync</span><span class="token punctuation">(</span><span class="token class-name">IssueAssignDto</span> input<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> issue <span class="token operator">=</span> <span class="token keyword">await</span> _issueRepository<span class="token punctuation">.</span><span class="token function">GetAsync</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>IssueId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> user <span class="token operator">=</span> <span class="token keyword">await</span> _userRepository<span class="token punctuation">.</span><span class="token function">GetAsync</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>UserId<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">await</span> _issueManager<span class="token punctuation">.</span><span class="token function">AssignToAsync</span><span class="token punctuation">(</span>issue<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">await</span> _issueRepository<span class="token punctuation">.</span><span class="token function">UpdateAsync</span><span class="token punctuation">(</span>issue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>An application service method typically has three steps those are implemented here;</p> <ol><li>Get the related domain objects from database to implement the use case.</li> <li>Use domain objects (domain services, entities, etc.) to perform the actual operation.</li> <li>Update the changed entities in the database.</li></ol> <blockquote><p>The last <em>Update</em> is not necessary if your are using EF Core since it has a Change Tracking system. If you want to take advantage of this EF Core feature, please see the <em>Discussion About the Database Independence Principle</em> section above.</p></blockquote> <p><code>IssueAssignDto</code> in this example is a simple DTO class:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">IssueTracking<span class="token punctuation">.</span>Issues</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IssueAssignDto</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> IssueId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> UserId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="data-transfer-objects"><a href="#data-transfer-objects" class="header-anchor">#</a> Data Transfer Objects</h3> <p>A <a href="/blogs/2021/Abp/Data-Transfer-Objects.html">DTO</a> is a simple object that is used to transfer state (data) between the Application and Presentation Layers. So, Application Service methods gets and returns DTOs.</p> <h4 id="common-dto-principles-best-practices"><a href="#common-dto-principles-best-practices" class="header-anchor">#</a> Common DTO Principles &amp; Best Practices</h4> <ul><li>A DTO <strong>should be serializable</strong>, by its nature. Because, most of the time it is transferred over network. So, it should have a <strong>parameterless (empty) constructor</strong>.</li> <li>Should not contain any <strong>business logic</strong>.</li> <li><strong>Never</strong> inherit from or reference to <strong>entities</strong>.</li></ul> <p><strong>Input DTOs</strong> (those are passed to the Application Service methods) have different natures than <strong>Output DTOs</strong> (those are returned from the Application Service methods). So, they will be treated differently.</p> <h4 id="input-dto-best-practices"><a href="#input-dto-best-practices" class="header-anchor">#</a> Input DTO Best Practices</h4> <h5 id="do-not-define-unused-properties-for-input-dtos"><a href="#do-not-define-unused-properties-for-input-dtos" class="header-anchor">#</a> Do not Define Unused Properties for Input DTOs</h5> <p>Define <strong>only the properties needed</strong> for the use case! Otherwise, it will be <strong>confusing for the clients</strong> to use the Application Service method. You can surely define <strong>optional properties</strong>, but they should effect how the use case is working, when the client provides them.</p> <p>This rule seems unnecessary first. Who would define unused parameters (input DTO properties) for a method? But it happens, especially when you try to reuse input DTOs.</p> <h5 id="do-not-re-use-input-dtos"><a href="#do-not-re-use-input-dtos" class="header-anchor">#</a> Do not Re-Use Input DTOs</h5> <p>Define a <strong>specialized input DTO for each use case</strong> (Application Service method). Otherwise, some properties are not used in some cases and this violates the rule defined above: <em>Do not Define Unused Properties for Input DTOs</em>.</p> <p>Sometimes, it seems appealing to reuse the same DTO class for two use cases, because they are almost same. Even if they are same now, they will probably become different by the time and you will come to the same problem. <strong>Code duplication is a better practice than coupling use cases</strong>.</p> <p>Another way of reusing input DTOs is <strong>inheriting</strong> DTOs from each other. While this can be useful in some rare cases, most of the time it brings you to the same point.</p> <p><strong>Example: User Application Service</strong></p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IUserAppService</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IApplicationService</span></span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">Task</span> <span class="token function">CreateAsync</span><span class="token punctuation">(</span><span class="token class-name">UserDto</span> input<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name">Task</span> <span class="token function">UpdateAsync</span><span class="token punctuation">(</span><span class="token class-name">UserDto</span> input<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name">Task</span> <span class="token function">ChangePasswordAsync</span><span class="token punctuation">(</span><span class="token class-name">UserDto</span> input<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><code>IUserAppService</code> uses <code>UserDto</code> as the input DTO in all methods (use cases). <code>UserDto</code> is defined below:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserDto</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> UserName <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Email <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Password <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> CreationTime <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>For this example;</p> <ul><li><code>Id</code> is not used in <em>Create</em> since the server determines it.</li> <li><code>Password</code> is not used in <em>Update</em> since we have another method for it.</li> <li><code>CreationTime</code> is never used since we can't allow client to send the Creation Time. It should be set in the server.</li></ul> <p>A true implementation can be like that:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IUserAppService</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IApplicationService</span></span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">Task</span> <span class="token function">CreateAsync</span><span class="token punctuation">(</span><span class="token class-name">UserCreationDto</span> input<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name">Task</span> <span class="token function">UpdateAsync</span><span class="token punctuation">(</span><span class="token class-name">UserUpdateDto</span> input<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name">Task</span> <span class="token function">ChangePasswordAsync</span><span class="token punctuation">(</span><span class="token class-name">UserChangePasswordDto</span> input<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>With the given input DTO classes:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserCreationDto</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> UserName <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Email <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Password <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserUpdateDto</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> UserName <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Email <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserChangePasswordDto</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Password <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>This is more maintainable approach although more code is written.</p> <p><strong>Exceptional Case</strong>: There can be some exceptions for this rule: If you always want to develop two methods <strong>in parallel</strong>, they may share the same input DTO (by inheritance or direct reuse). For example, if you have a reporting page that has some filters and you have multiple Application Service methods (like screen report, excel report and csv report methods) use the same filters but returns different results, you may want to reuse the same filter input DTO to <strong>couple these use cases</strong>. Because, in this example, whenever you change a filter, you have to make the necessary changes in all the methods to have a consistent reporting system.</p> <h5 id="input-dto-validation-logic"><a href="#input-dto-validation-logic" class="header-anchor">#</a> Input DTO Validation Logic</h5> <ul><li>Implement only <strong>formal validation</strong> inside the DTO. Use Data Annotation Validation Attributes or implement <code>IValidatableObject</code> for formal validation.</li> <li><strong>Do not perform domain validation</strong>. For example, don't try to check unique username constraint in the DTOs.</li></ul> <p><strong>Example: Using Data Annotation Attributes</strong></p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>ComponentModel<span class="token punctuation">.</span>DataAnnotations</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">IssueTracking<span class="token punctuation">.</span>Users</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserCreationDto</span>
    <span class="token punctuation">{</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Required</span></span><span class="token punctuation">]</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">StringLength</span><span class="token attribute-arguments"><span class="token punctuation">(</span>UserConsts<span class="token punctuation">.</span>MaxUserNameLength<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> UserName <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Required</span></span><span class="token punctuation">]</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">EmailAddress</span></span><span class="token punctuation">]</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">StringLength</span><span class="token attribute-arguments"><span class="token punctuation">(</span>UserConsts<span class="token punctuation">.</span>MaxEmailLength<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Email <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Required</span></span><span class="token punctuation">]</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">StringLength</span><span class="token attribute-arguments"><span class="token punctuation">(</span>UserConsts<span class="token punctuation">.</span>MaxEmailLength<span class="token punctuation">,</span>
        MinimumLength <span class="token operator">=</span> UserConsts<span class="token punctuation">.</span>MinPasswordLength<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Password <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>ABP Framework automatically validates input DTOs, throws <code>AbpValidationException</code> and returns HTTP Status <code>400</code> to the client in case of an invalid input.</p> <blockquote><p>Some developers think it is better to separate the validation rules and DTO classes. We think the declarative (Data Annotation) approach is practical and useful and doesn't cause any design problem. However, ABP also supports <a href="/blogs/2021/Abp/FluentValidation.html">FluentValidation integration</a> if you prefer the other approach.</p></blockquote> <blockquote><p>See the <a href="/blogs/2021/Abp/Validation.html">Validation document</a> for all validation options.</p></blockquote> <h4 id="output-dto-best-practices"><a href="#output-dto-best-practices" class="header-anchor">#</a> Output DTO Best Practices</h4> <ul><li>Keep output <strong>DTO count minimum</strong>. <strong>Reuse</strong> where possible (exception: Do not reuse input DTOs as output DTOs).</li> <li>Output DTOs can contain <strong>more properties</strong> than used in the client code.</li> <li>Return entity DTO from <strong>Create</strong> and <strong>Update</strong> methods.</li></ul> <p>The main goals of these suggestions are;</p> <ul><li>Make client code easy to develop and extend;
<ul><li>Dealing with <strong>similar, but not same</strong> DTOs are problematic on the client side.</li> <li>It is common to <strong>need to other properties</strong> on the UI/client in the future. Returning all properties (by considering security and privileges) of an entity makes client code easy to improve without requiring to touch to the backend code.</li> <li>If you are opening your API to <strong>3rd-party clients</strong> that you don't know requirements of each client.</li></ul></li> <li>Make the server side code easy to develop and extend;
<ul><li>You have less class to <strong>understand and maintain</strong>.</li> <li>You can reuse the Entity-&gt;DTO <strong>object mapping</strong> code.</li> <li>Returning same types from different methods make it easy and clear to create <strong>new methods</strong>.</li></ul></li></ul> <p><strong>Example: Returning Different DTO types from different methods</strong></p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IUserAppService</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IApplicationService</span></span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">UserDto</span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token class-name">Guid</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token return-type class-name">List<span class="token punctuation">&lt;</span>UserNameAndEmailDto<span class="token punctuation">&gt;</span></span> <span class="token function">GetUserNameAndEmail</span><span class="token punctuation">(</span><span class="token class-name">Guid</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token return-type class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetRoles</span><span class="token punctuation">(</span><span class="token class-name">Guid</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name">List<span class="token punctuation">&lt;</span>UserListDto<span class="token punctuation">&gt;</span></span> <span class="token function">GetList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name">UserCreateResultDto</span> <span class="token function">Create</span><span class="token punctuation">(</span><span class="token class-name">UserCreationDto</span> input<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name">UserUpdateResultDto</span> <span class="token function">Update</span><span class="token punctuation">(</span><span class="token class-name">UserUpdateDto</span> input<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><em>(We didn't use async methods to make the example cleaner, but use async in your real world application!)</em></p> <p>The example code above returns different DTO types for each method. As you can guess, there will be a lot of code duplications for querying data, mapping entities to DTOs.</p> <p>The <code>IUserAppService</code> service above can be simplified:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IUserAppService</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IApplicationService</span></span>
<span class="token punctuation">{</span>
    <span class="token return-type class-name">UserDto</span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token class-name">Guid</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name">List<span class="token punctuation">&lt;</span>UserDto<span class="token punctuation">&gt;</span></span> <span class="token function">GetList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name">UserDto</span> <span class="token function">Create</span><span class="token punctuation">(</span><span class="token class-name">UserCreationDto</span> input<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token return-type class-name">UserDto</span> <span class="token function">Update</span><span class="token punctuation">(</span><span class="token class-name">UserUpdateDto</span> input<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>With a single output DTO:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserDto</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> UserName <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Email <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> CreationTime <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> Roles <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>Removed <code>GetUserNameAndEmail</code> and <code>GetRoles</code> since <code>Get</code> method already returns the necessary information.</li> <li><code>GetList</code> now returns the same with <code>Get</code>.</li> <li><code>Create</code> and <code>Update</code> also returns the same <code>UserDto</code>.</li></ul> <p>Using the same DTO has a lot of advantages as explained before. For example, think a scenario where you show a <strong>data grid</strong> of Users on the UI. After updating a user, you can get the return value and <strong>update it on the UI</strong>. So, you don't need to call <code>GetList</code> again. This is why we suggest to return the entity DTO (<code>UserDto</code> here) as return value from the <code>Create</code> and <code>Update</code> operations.</p> <h5 id="discussion"><a href="#discussion" class="header-anchor">#</a> Discussion</h5> <p>Some of the output DTO suggestions may not fit in every scenario. These suggestions can be ignored for <strong>performance</strong> reasons, especially when <strong>large data sets</strong> returned or when you create services for your own UI and you have <strong>too many concurrent requests</strong>.</p> <p>In these cases, you may want to create <strong>specialized output DTOs with minimal information</strong>. The suggestions above are especially for applications where <strong>maintaining the codebase</strong> is more important than <strong>negligible performance lost</strong>.</p> <h4 id="object-to-object-mapping"><a href="#object-to-object-mapping" class="header-anchor">#</a> Object to Object Mapping</h4> <p>Automatic <a href="/blogs/2021/Abp/Object-To-Object-Mapping.html">object to object mapping</a> is a useful approach to copy values from one object to another when two objects have same or similar properties.</p> <p>DTO and Entity classes generally have same/similar properties and you typically need to create DTO objects from Entities. ABP's <a href="/blogs/2021/Abp/Object-To-Object-Mapping.html">object to object mapping system</a> with <a href="http://automapper.org/" target="_blank" rel="noopener noreferrer">AutoMapper<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> integration makes these operations much easier comparing to manual mapping.</p> <ul><li><strong>Use</strong> auto object mapping only for <strong>Entity to output DTO</strong> mappings.</li> <li><strong>Do not use</strong> auto object mapping for <strong>input DTO to Entity</strong> mappings.</li></ul> <p>There are some reasons why you <strong>should not use</strong> input DTO to Entity auto mapping;</p> <ol><li>An Entity class typically has a <strong>constructor</strong> that takes parameters and ensures valid object creation. Auto object mapping operation generally requires an empty constructor.</li> <li>Most of the entity properties will have <strong>private setters</strong> and you should use methods to change these properties in a controlled way.</li> <li>You typically need to <strong>carefully validate and process</strong> the user/client input rather than blindly mapping to the entity properties.</li></ol> <p>While some of these problems can be solved through mapping configurations (For example, AutoMapper allows to define custom mapping rules), it makes your business code <strong>implicit/hidden</strong> and <strong>tightly coupled</strong> to the infrastructure. We think the business code should be explicit, clear and easy to understand.</p> <p>See the <em>Entity Creation</em> section below for an example implementation of the suggestions made in this section.</p> <h2 id="example-use-cases"><a href="#example-use-cases" class="header-anchor">#</a> Example Use Cases</h2> <p>This section will demonstrate some example use cases and discuss alternative scenarios.</p> <h3 id="entity-creation"><a href="#entity-creation" class="header-anchor">#</a> Entity Creation</h3> <p>Creating an object from an Entity / Aggregate Root class is the first step of the lifecycle of that entity. The <em>Aggregate / Aggregate Root Rules &amp; Best Practices</em> section suggests to <strong>create a primary constructor</strong> for the Entity class that guarantees to <strong>create a valid entity</strong>. So, whenever we need to create an instance of that entity, we should always <strong>use that constructor</strong>.</p> <p>See the <code>Issue</code> Aggregate Root class below:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Issue</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">AggregateRoot<span class="token punctuation">&lt;</span>Guid<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> RepositoryId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Title <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Text <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid<span class="token punctuation">?</span></span> AssignedUserId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">internal</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">Issue</span><span class="token punctuation">(</span>
        <span class="token class-name">Guid</span> id<span class="token punctuation">,</span>
        <span class="token class-name">Guid</span> repositoryId<span class="token punctuation">,</span>
        <span class="token class-name"><span class="token keyword">string</span></span> title<span class="token punctuation">,</span>
        <span class="token class-name"><span class="token keyword">string</span></span> text <span class="token operator">=</span> <span class="token keyword">null</span>
        <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        RepositoryId <span class="token operator">=</span> repositoryId<span class="token punctuation">;</span>
        Title <span class="token operator">=</span> Check<span class="token punctuation">.</span><span class="token function">NotNullOrWhiteSpace</span><span class="token punctuation">(</span>title<span class="token punctuation">,</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>title<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Text <span class="token operator">=</span> text<span class="token punctuation">;</span> <span class="token comment">//Allow empty/null</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">private</span> <span class="token function">Issue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* Empty constructor is for ORMs */</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SetTitle</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> title<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Title <span class="token operator">=</span> Check<span class="token punctuation">.</span><span class="token function">NotNullOrWhiteSpace</span><span class="token punctuation">(</span>title<span class="token punctuation">,</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>title<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><ul><li>This class guarantees to create a valid entity by its constructor.</li> <li>If you need to change the <code>Title</code> later, you need to use the <code>SetTitle</code> method which continues to keep <code>Title</code> in a valid state.</li> <li>If you want to assign this issue to a user, you need to use <code>IssueManager</code> (it implements some business rules before the assignment - see the <em>Domain Services</em> section above to remember).</li> <li>The <code>Text</code> property has a public setter, because it also accepts null values and does not have any validation rules for this example. It is also optional in the constructor.</li></ul> <p>Let's see an Application Service method that is used to create an issue:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IssueAppService</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ApplicationService</span><span class="token punctuation">,</span> <span class="token class-name">IIssueAppService</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IssueManager</span> _issueManager<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IRepository<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">,</span> Guid<span class="token punctuation">&gt;</span></span> _issueRepository<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IRepository<span class="token punctuation">&lt;</span>AppUser<span class="token punctuation">,</span> Guid<span class="token punctuation">&gt;</span></span> _userRepository<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">IssueAppService</span><span class="token punctuation">(</span>
        <span class="token class-name">IssueManager</span> issueManager<span class="token punctuation">,</span>
        <span class="token class-name">IRepository<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">,</span> Guid<span class="token punctuation">&gt;</span></span> issueRepository<span class="token punctuation">,</span>
        <span class="token class-name">IRepository<span class="token punctuation">&lt;</span>AppUser<span class="token punctuation">,</span> Guid<span class="token punctuation">&gt;</span></span> userRepository<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _issueManager <span class="token operator">=</span> issueManager<span class="token punctuation">;</span>
        _issueRepository <span class="token operator">=</span> issueRepository<span class="token punctuation">;</span>
        _userRepository <span class="token operator">=</span> userRepository<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>IssueDto<span class="token punctuation">&gt;</span></span> <span class="token function">CreateAsync</span><span class="token punctuation">(</span><span class="token class-name">IssueCreationDto</span> input<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// Create a valid entity</span>
        <span class="token class-name"><span class="token keyword">var</span></span> issue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Issue</span><span class="token punctuation">(</span>
            GuidGenerator<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            input<span class="token punctuation">.</span>RepositoryId<span class="token punctuation">,</span>
            input<span class="token punctuation">.</span>Title<span class="token punctuation">,</span>
            input<span class="token punctuation">.</span>Text
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Apply additional domain actions</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>input<span class="token punctuation">.</span>AssignedUserId<span class="token punctuation">.</span>HasValue<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> user <span class="token operator">=</span> <span class="token keyword">await</span> _userRepository<span class="token punctuation">.</span><span class="token function">GetAsync</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>AssignedUserId<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">await</span> _issueManager<span class="token punctuation">.</span><span class="token function">AssignToAsync</span><span class="token punctuation">(</span>issue<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Save</span>
        <span class="token keyword">await</span> _issueRepository<span class="token punctuation">.</span><span class="token function">InsertAsync</span><span class="token punctuation">(</span>issue<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Return a DTO represents the new Issue</span>
        <span class="token keyword">return</span> ObjectMapper<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Map</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Issue<span class="token punctuation">,</span> IssueDto<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>issue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p><code>CreateAsync</code> method;</p> <ul><li>Uses the <code>Issue</code> <strong>constructor</strong> to create a valid issue. It passes the <code>Id</code> using the <a href="/blogs/2021/Abp/Guid-Generation.html">IGuidGenerator</a> service. It doesn't use auto object mapping here.</li> <li>If the client wants to <strong>assign this issue to a user</strong> on object creation, it uses the <code>IssueManager</code> to do it by allowing the <code>IssueManager</code> to perform the necessary checks before this assignment.</li> <li><strong>Saves</strong> the entity to the database.</li> <li>Finally uses the <code>IObjectMapper</code> to return an <code>IssueDto</code> that is automatically created by <strong>mapping</strong> from the new <code>Issue</code> entity.</li></ul> <h4 id="applying-domain-rules-on-entity-creation"><a href="#applying-domain-rules-on-entity-creation" class="header-anchor">#</a> Applying Domain Rules on Entity Creation</h4> <p>The example <code>Issue</code> entity has no business rule on entity creation, except some formal validations in the constructor. However, there maybe scenarios where entity creation should check some extra business rules.</p> <p>For example, assume that you <strong>don't want</strong> to allow to create an issue if there is already an issue with <strong>exactly the same <code>Title</code></strong>. Where to implement this rule? It is <strong>not proper</strong> to implement this rule in the <strong>Application Service</strong>, because it is a <strong>core business (domain) rule</strong> that should always be checked.</p> <p>This rule should be implemented in a <strong>Domain Service</strong>, <code>IssueManager</code> in this case. So, we need to force the Application Layer always to use the <code>IssueManager</code> to create a new <code>Issue.</code></p> <p>First, we can make the <code>Issue</code> constructor <code>internal</code>, instead of <code>public</code>:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Issue</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">AggregateRoot<span class="token punctuation">&lt;</span>Guid<span class="token punctuation">&gt;</span></span></span>
<span class="token punctuation">{</span>
    <span class="token comment">//...</span>

    <span class="token keyword">internal</span> <span class="token function">Issue</span><span class="token punctuation">(</span>
        <span class="token class-name">Guid</span> id<span class="token punctuation">,</span>
        <span class="token class-name">Guid</span> repositoryId<span class="token punctuation">,</span>
        <span class="token class-name"><span class="token keyword">string</span></span> title<span class="token punctuation">,</span>
        <span class="token class-name"><span class="token keyword">string</span></span> text <span class="token operator">=</span> <span class="token keyword">null</span>
        <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        RepositoryId <span class="token operator">=</span> repositoryId<span class="token punctuation">;</span>
        Title <span class="token operator">=</span> Check<span class="token punctuation">.</span><span class="token function">NotNullOrWhiteSpace</span><span class="token punctuation">(</span>title<span class="token punctuation">,</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>title<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Text <span class="token operator">=</span> text<span class="token punctuation">;</span> <span class="token comment">//Allow empty/null</span>
    <span class="token punctuation">}</span>
        
    <span class="token comment">//...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>This prevents Application Services to directly use the constructor, so they will use the <code>IssueManager</code>. Then we can add a <code>CreateAsync</code> method to the <code>IssueManager</code>:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Volo<span class="token punctuation">.</span>Abp</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Volo<span class="token punctuation">.</span>Abp<span class="token punctuation">.</span>Domain<span class="token punctuation">.</span>Repositories</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Volo<span class="token punctuation">.</span>Abp<span class="token punctuation">.</span>Domain<span class="token punctuation">.</span>Services</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">IssueTracking<span class="token punctuation">.</span>Issues</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IssueManager</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">DomainService</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IRepository<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">,</span> Guid<span class="token punctuation">&gt;</span></span> _issueRepository<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token function">IssueManager</span><span class="token punctuation">(</span><span class="token class-name">IRepository<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">,</span> Guid<span class="token punctuation">&gt;</span></span> issueRepository<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            _issueRepository <span class="token operator">=</span> issueRepository<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">&gt;</span></span> <span class="token function">CreateAsync</span><span class="token punctuation">(</span>
            <span class="token class-name">Guid</span> repositoryId<span class="token punctuation">,</span>
            <span class="token class-name"><span class="token keyword">string</span></span> title<span class="token punctuation">,</span>
            <span class="token class-name"><span class="token keyword">string</span></span> text <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">await</span> _issueRepository<span class="token punctuation">.</span><span class="token function">AnyAsync</span><span class="token punctuation">(</span>i <span class="token operator">=&gt;</span> i<span class="token punctuation">.</span>Title <span class="token operator">==</span> title<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">BusinessException</span><span class="token punctuation">(</span><span class="token string">&quot;IssueTracking:IssueWithSameTitleExists&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Issue</span><span class="token punctuation">(</span>
                GuidGenerator<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                repositoryId<span class="token punctuation">,</span>
                title<span class="token punctuation">,</span>
                text
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><ul><li><code>CreateAsync</code> method checks if there is already an issue with the same title and throws a business exception in this case.</li> <li>If there is no duplication, it creates and returns a new <code>Issue</code>.</li></ul> <p>The <code>IssueAppService</code> is changed as shown below in order to use the <code>IssueManager</code>'s <code>CreateAsync</code> method:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IssueAppService</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ApplicationService</span><span class="token punctuation">,</span> <span class="token class-name">IIssueAppService</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IssueManager</span> _issueManager<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IRepository<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">,</span> Guid<span class="token punctuation">&gt;</span></span> _issueRepository<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IRepository<span class="token punctuation">&lt;</span>AppUser<span class="token punctuation">,</span> Guid<span class="token punctuation">&gt;</span></span> _userRepository<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">IssueAppService</span><span class="token punctuation">(</span>
        <span class="token class-name">IssueManager</span> issueManager<span class="token punctuation">,</span>
        <span class="token class-name">IRepository<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">,</span> Guid<span class="token punctuation">&gt;</span></span> issueRepository<span class="token punctuation">,</span>
        <span class="token class-name">IRepository<span class="token punctuation">&lt;</span>AppUser<span class="token punctuation">,</span> Guid<span class="token punctuation">&gt;</span></span> userRepository<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _issueManager <span class="token operator">=</span> issueManager<span class="token punctuation">;</span>
        _issueRepository <span class="token operator">=</span> issueRepository<span class="token punctuation">;</span>
        _userRepository <span class="token operator">=</span> userRepository<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>IssueDto<span class="token punctuation">&gt;</span></span> <span class="token function">CreateAsync</span><span class="token punctuation">(</span><span class="token class-name">IssueCreationDto</span> input<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// Create a valid entity using the IssueManager</span>
        <span class="token class-name"><span class="token keyword">var</span></span> issue <span class="token operator">=</span> <span class="token keyword">await</span> _issueManager<span class="token punctuation">.</span><span class="token function">CreateAsync</span><span class="token punctuation">(</span>
            input<span class="token punctuation">.</span>RepositoryId<span class="token punctuation">,</span>
            input<span class="token punctuation">.</span>Title<span class="token punctuation">,</span>
            input<span class="token punctuation">.</span>Text
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Apply additional domain actions</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>input<span class="token punctuation">.</span>AssignedUserId<span class="token punctuation">.</span>HasValue<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> user <span class="token operator">=</span> <span class="token keyword">await</span> _userRepository<span class="token punctuation">.</span><span class="token function">GetAsync</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>AssignedUserId<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">await</span> _issueManager<span class="token punctuation">.</span><span class="token function">AssignToAsync</span><span class="token punctuation">(</span>issue<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Save</span>
        <span class="token keyword">await</span> _issueRepository<span class="token punctuation">.</span><span class="token function">InsertAsync</span><span class="token punctuation">(</span>issue<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Return a DTO represents the new Issue</span>
        <span class="token keyword">return</span> ObjectMapper<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Map</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Issue<span class="token punctuation">,</span> IssueDto<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>issue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>

<span class="token comment">// *** IssueCreationDto class ***</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IssueCreationDto</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> RepositoryId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Required</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Title <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid<span class="token punctuation">?</span></span> AssignedUserId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Text <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><h5 id="discussion-why-is-the-issue-not-saved-to-the-database-in-issuemanager"><a href="#discussion-why-is-the-issue-not-saved-to-the-database-in-issuemanager" class="header-anchor">#</a> Discussion: Why is the Issue not saved to the database in <code>IssueManager</code>?</h5> <p>You may ask &quot;<strong>Why didn't <code>IssueManager</code> save the <code>Issue</code> to the database?</strong>&quot;. We think it is the responsibility of the Application Service.</p> <p>Because, the Application Service may require additional changes/operations on the <code>Issue</code> object before saving it. If Domain Service saves it, then the <em>Save</em> operation is duplicated;</p> <ul><li>It causes performance lost because of double database round trip.</li> <li>It requires explicit database transaction that covers both operations.</li> <li>If additional actions cancel the entity creation because of a business rule, the transaction should be rolled back in the database.</li></ul> <p>When you check the <code>IssueAppService</code>, you will see the advantage of <strong>not saving</strong> <code>Issue</code> to the database in the <code>IssueManager.CreateAsync</code>. Otherwise, we would need to perform one <em>Insert</em> (in the <code>IssueManager</code>) and one <em>Update</em> (after the Assignment).</p> <h5 id="discussion-why-is-the-duplicate-title-check-not-implemented-in-the-application-service"><a href="#discussion-why-is-the-duplicate-title-check-not-implemented-in-the-application-service" class="header-anchor">#</a> Discussion: Why is the duplicate Title check not implemented in the Application Service?</h5> <p>We could simple say &quot;Because it is a <strong>core domain logic</strong> and should be implemented in the Domain Layer&quot;. However, it brings a new question &quot;<strong>How did you decide</strong> that it is a core domain logic, but not an application logic?&quot; (we will discuss the difference later with more details).</p> <p>For this example, a simple question can help us to make the decision: &quot;If we have another way (use case) of creating an issue, should we still apply the same rule? Is that rule should <em>always</em> be implemented&quot;. You may think &quot;Why do we have a second way of creating an issue?&quot;. However, in real life, you have;</p> <ul><li><strong>End users</strong> of the application may create issues in your application's standard UI.</li> <li>You may have a second <strong>back office</strong> application that is used by your own employees and you may want to provide a way of creating issues (probably with different authorization rules in this case).</li> <li>You may have an HTTP API that is open to <strong>3rd-party clients</strong> and they create issues.</li> <li>You may have a <strong>background worker</strong> service that do something and creates issues if it detects some problems. In this way, it will create an issue without any user interaction (and probably without any standard authorization check).</li> <li>You may have a button on the UI that <strong>converts</strong> something (for example, a discussion) to an issue.</li></ul> <p>We can give more examples. All of these are should be implemented by <strong>different Application Service methods</strong> (see the <em>Multiple Application Layers</em> section below), but they <strong>always</strong> follow the rule: Title of the new issue can not be same of any existing issue! That's why this logic is a <strong>core domain logic</strong>, should be located in the Domain Layer and <strong>should not be duplicated</strong> in all these application service methods.</p> <h3 id="updating-manipulating-an-entity"><a href="#updating-manipulating-an-entity" class="header-anchor">#</a> Updating / Manipulating An Entity</h3> <p>Once an entity is created, it is updated/manipulated by the use cases until it is deleted from the system. There can be different types of the use cases directly or indirectly changes an entity.</p> <p>In this section, we will discuss a typical update operation that changes multiple properties of an <code>Issue</code>.</p> <p>This time, beginning from the <em>Update</em> DTO:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UpdateIssueDto</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Required</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Title <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Text <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid<span class="token punctuation">?</span></span> AssignedUserId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>By comparing to <code>IssueCreationDto</code>, you see no <code>RepositoryId</code>. Because, our system doesn't allow to move issues across repositories (think as GitHub repositories). Only <code>Title</code> is required and the other properties are optional.</p> <p>Let's see the <em>Update</em> implementation in the <code>IssueAppService</code>:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IssueAppService</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ApplicationService</span><span class="token punctuation">,</span> <span class="token class-name">IIssueAppService</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IssueManager</span> _issueManager<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IRepository<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">,</span> Guid<span class="token punctuation">&gt;</span></span> _issueRepository<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IRepository<span class="token punctuation">&lt;</span>AppUser<span class="token punctuation">,</span> Guid<span class="token punctuation">&gt;</span></span> _userRepository<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">IssueAppService</span><span class="token punctuation">(</span>
        <span class="token class-name">IssueManager</span> issueManager<span class="token punctuation">,</span>
        <span class="token class-name">IRepository<span class="token punctuation">&lt;</span>Issue<span class="token punctuation">,</span> Guid<span class="token punctuation">&gt;</span></span> issueRepository<span class="token punctuation">,</span>
        <span class="token class-name">IRepository<span class="token punctuation">&lt;</span>AppUser<span class="token punctuation">,</span> Guid<span class="token punctuation">&gt;</span></span> userRepository<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _issueManager <span class="token operator">=</span> issueManager<span class="token punctuation">;</span>
        _issueRepository <span class="token operator">=</span> issueRepository<span class="token punctuation">;</span>
        _userRepository <span class="token operator">=</span> userRepository<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>IssueDto<span class="token punctuation">&gt;</span></span> <span class="token function">UpdateAsync</span><span class="token punctuation">(</span><span class="token class-name">Guid</span> id<span class="token punctuation">,</span> <span class="token class-name">UpdateIssueDto</span> input<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// Get entity from database</span>
        <span class="token class-name"><span class="token keyword">var</span></span> issue <span class="token operator">=</span> <span class="token keyword">await</span> _issueRepository<span class="token punctuation">.</span><span class="token function">GetAsync</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Change Title</span>
        <span class="token keyword">await</span> _issueManager<span class="token punctuation">.</span><span class="token function">ChangeTitleAsync</span><span class="token punctuation">(</span>issue<span class="token punctuation">,</span> input<span class="token punctuation">.</span>Title<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Change Assigned User</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>input<span class="token punctuation">.</span>AssignedUserId<span class="token punctuation">.</span>HasValue<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> user <span class="token operator">=</span> <span class="token keyword">await</span> _userRepository<span class="token punctuation">.</span><span class="token function">GetAsync</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>AssignedUserId<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">await</span> _issueManager<span class="token punctuation">.</span><span class="token function">AssignToAsync</span><span class="token punctuation">(</span>issue<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Change Text (no business rule, all values accepted)</span>
        issue<span class="token punctuation">.</span>Text <span class="token operator">=</span> input<span class="token punctuation">.</span>Text<span class="token punctuation">;</span>

        <span class="token comment">// Update entity in the database</span>
        <span class="token keyword">await</span> _issueRepository<span class="token punctuation">.</span><span class="token function">UpdateAsync</span><span class="token punctuation">(</span>issue<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Return a DTO represents the new Issue</span>
        <span class="token keyword">return</span> ObjectMapper<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Map</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Issue<span class="token punctuation">,</span> IssueDto<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>issue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><ul><li><code>UpdateAsync</code> method gets <code>id</code> as a separate parameter. It is not included in the <code>UpdateIssueDto</code>. This is a design decision that helps ABP to properly define HTTP routes when you <a href="/blogs/2021/Abp/API/Auto-API-Controllers.html">auto expose</a> this service as an HTTP API endpoint. So, that's not related to DDD.</li> <li>It starts by <strong>getting</strong> the <code>Issue</code> entity <strong>from the database</strong>.</li> <li>Uses <code>IssueManager</code>'s <code>ChangeTitleAsync</code> instead of directly calling <code>Issue.SetTitle(...)</code>. Because we need to implement the <strong>duplicate Title check</strong> as just done in the <em>Entity Creation</em>. This requires some changes in the <code>Issue</code> and <code>IssueManager</code> classes (will be explained below).</li> <li>Uses <code>IssueManager</code>'s <code>AssignToAsync</code> method if the <strong>assigned user</strong> is being changed with this request.</li> <li>Directly sets the <code>Issue.Text</code> since there is <strong>no business rule</strong> for that. If we need later, we can always refactor.</li> <li><strong>Saves changes</strong> to the database. Again, saving changed entities is a responsibility of the Application Service method that coordinates the business objects and the transaction. If the <code>IssueManager</code> had saved internally in <code>ChangeTitleAsync</code> and <code>AssignToAsync</code> method, there would be double database operation (see the <em>Discussion: Why is the Issue not saved to the database in <code>IssueManager</code>?</em> above).</li> <li>Finally uses the <code>IObjectMapper</code> to return an <code>IssueDto</code> that is automatically created by <strong>mapping</strong> from the updated <code>Issue</code> entity.</li></ul> <p>As said, we need some changes in the <code>Issue</code> and <code>IssueManager</code> classes.</p> <p>First, made <code>SetTitle</code> internal in the <code>Issue</code> class:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">internal</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SetTitle</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> title<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Title <span class="token operator">=</span> Check<span class="token punctuation">.</span><span class="token function">NotNullOrWhiteSpace</span><span class="token punctuation">(</span>title<span class="token punctuation">,</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>title<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>Then added a new method to the <code>IssueManager</code> to change the Title:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">ChangeTitleAsync</span><span class="token punctuation">(</span><span class="token class-name">Issue</span> issue<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> title<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>issue<span class="token punctuation">.</span>Title <span class="token operator">==</span> title<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">await</span> _issueRepository<span class="token punctuation">.</span><span class="token function">AnyAsync</span><span class="token punctuation">(</span>i <span class="token operator">=&gt;</span> i<span class="token punctuation">.</span>Title <span class="token operator">==</span> title<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">BusinessException</span><span class="token punctuation">(</span><span class="token string">&quot;IssueTracking:IssueWithSameTitleExists&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    issue<span class="token punctuation">.</span><span class="token function">SetTitle</span><span class="token punctuation">(</span>title<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="domain-logic-application-logic"><a href="#domain-logic-application-logic" class="header-anchor">#</a> Domain Logic &amp; Application Logic</h2> <p>As mentioned before, <em>Business Logic</em> in the Domain Driven Design is spitted into two parts (layers): <em>Domain Logic</em> and <em>Application Logic</em>:</p> <p><img src="/assets/img/domain-driven-design-domain-vs-application-logic.796388e2.png" alt="domain-driven-design-domain-vs-application-logic"></p> <p>Domain Logic consists of the <em>Core Domain Rules</em> of the system while Application Logic implements application specific <em>Use Cases</em>.</p> <p>While the definition is clear, the implementation may not be easy. You may be undecided which code should stand in the Application Layer, which code should be in the Domain Layer.  This section tries to explain the differences.</p> <h3 id="multiple-application-layers"><a href="#multiple-application-layers" class="header-anchor">#</a> Multiple Application Layers</h3> <p>DDD helps to <strong>deal with complexity</strong> when your system is large. Especially, if there are <strong>multiple applications</strong>  are being developed in a <strong>single domain,</strong> then the <strong>Domain Logic vs Application Logic separation</strong> becomes much more important.</p> <p>Assume that you are building a system that has multiple applications;</p> <ul><li>A <strong>Public Web Site Application</strong>, built with ASP.NET Core MVC, to show your products to users. Such a web site doesn't require authentication to see the products. The users login to the web site, only if they are performing some actions (like adding a product to the basket).</li> <li>A <strong>Back Office Application</strong>, built with Angular UI (that uses REST APIs). This application used by office workers of the company to manage the system (like editing product descriptions).</li> <li>A <strong>Mobile Application</strong> that has much simpler UI compared to the Public Web Site. It may communicate to the server via REST APIs or another technology (like TCP sockets).</li></ul> <p><img src="/assets/img/domain-driven-design-multiple-applications.3e848130.png" alt="domain-driven-design-multiple-applications"></p> <p>Every application will have different <strong>requirements</strong>, different <strong>use cases</strong> (Application Service methods), different <strong>DTOs</strong>, different <strong>validation</strong> and <strong>authorization</strong> rules... etc.</p> <p>Mixing all these logics into a single application layer makes your services contain too many <code>if</code> conditions with <strong>complicated business logic</strong> makes your code <strong>harder to develop, maintain and test</strong> and leads to potential bugs.</p> <p>If you've multiple applications with a single domain;</p> <ul><li>Create <strong>separate application layers</strong> for each application/client type and implement application specific business logic in these separate layers.</li> <li>Use a <strong>single domain layer</strong> to share the core domain logic.</li></ul> <p>Such a design makes it even more important to distinguish between Domain logic and Application Logic.</p> <p>To be more clear about the implementation, you can create different projects (<code>.csproj</code>) for each application types. For example;</p> <ul><li><code>IssueTracker.Admin.Application</code> &amp; <code>IssueTracker.Admin.Application.Contacts</code> projects for the Back Office (admin) Application.</li> <li><code>IssueTracker.Public.Application</code> &amp; <code>IssueTracker.Public.Application.Contracts</code> projects for the Public Web Application.</li> <li><code>IssueTracker.Mobile.Application</code> &amp; <code>IssueTracker.Mobile.Application.Contracts</code> projects for the Mobile Application.</li></ul> <h3 id="examples"><a href="#examples" class="header-anchor">#</a> Examples</h3> <p>This section contains some Application Service and Domain Service examples to discuss how to decide to place business logic inside these services.</p> <p><strong>Example: Creating a new <code>Organization</code> in a Domain Service</strong></p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrganizationManager</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">DomainService</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IRepository<span class="token punctuation">&lt;</span>Organization<span class="token punctuation">&gt;</span></span> _organizationRepository<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ICurrentUser</span> _currentUser<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IAuthorizationService</span> _authorizationService<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IEmailSender</span> _emailSender<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">OrganizationManager</span><span class="token punctuation">(</span>
        <span class="token class-name">IRepository<span class="token punctuation">&lt;</span>Organization<span class="token punctuation">&gt;</span></span> organizationRepository<span class="token punctuation">,</span> 
        <span class="token class-name">ICurrentUser</span> currentUser<span class="token punctuation">,</span> 
        <span class="token class-name">IAuthorizationService</span> authorizationService<span class="token punctuation">,</span> 
        <span class="token class-name">IEmailSender</span> emailSender<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _organizationRepository <span class="token operator">=</span> organizationRepository<span class="token punctuation">;</span>
        _currentUser <span class="token operator">=</span> currentUser<span class="token punctuation">;</span>
        _authorizationService <span class="token operator">=</span> authorizationService<span class="token punctuation">;</span>
        _emailSender <span class="token operator">=</span> emailSender<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>Organization<span class="token punctuation">&gt;</span></span> <span class="token function">CreateAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> name<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">await</span> _organizationRepository<span class="token punctuation">.</span><span class="token function">AnyAsync</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>Name <span class="token operator">==</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">BusinessException</span><span class="token punctuation">(</span><span class="token string">&quot;IssueTracking:DuplicateOrganizationName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">await</span> _authorizationService<span class="token punctuation">.</span><span class="token function">CheckAsync</span><span class="token punctuation">(</span><span class="token string">&quot;OrganizationCreationPermission&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        Logger<span class="token punctuation">.</span><span class="token function">LogDebug</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;Creating organization </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">name</span><span class="token punctuation">}</span></span><span class="token string"> by </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">_currentUser<span class="token punctuation">.</span>UserName</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> organization <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Organization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">await</span> _emailSender<span class="token punctuation">.</span><span class="token function">SendAsync</span><span class="token punctuation">(</span>
            <span class="token string">&quot;systemadmin@issuetracking.com&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;New Organization&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;A new organization created with name: &quot;</span> <span class="token operator">+</span> name
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> organization<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>Let's see the <code>CreateAsync</code> method step by step to discuss if the code part should be in the Domain Service, or not;</p> <ul><li><strong>CORRECT</strong>: It first checks for <strong>duplicate organization name</strong> and and throws exception in this case. This is something related to core domain rule and we never allow duplicated names.</li> <li><strong>WRONG</strong>: Domain Services should not perform <strong>authorization</strong>. <a href="/blogs/2021/Abp/Authorization.html">Authorization</a> should be done in the Application Layer.</li> <li><strong>WRONG</strong>: It logs a message with including the <a href="/blogs/2021/Abp/CurrentUser.html">Current User</a>'s <code>UserName</code>. Domain service should not be depend on the Current User. Domain Services should be usable even if there is no user in the system. Current User (Session) should be a Presentation/Application Layer related concept.</li> <li><strong>WRONG</strong>: It sends an <a href="/blogs/2021/Abp/Emailing.html">email</a> about this new organization creation. We think this is also a use case specific business logic. You may want to create different type of emails in different use cases or don't need to send emails in some cases.</li></ul> <p><strong>Example: Creating a new <code>Organization</code> in an Application Service</strong></p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrganizationAppService</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ApplicationService</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">OrganizationManager</span> _organizationManager<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IPaymentService</span> _paymentService<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IEmailSender</span> _emailSender<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">OrganizationAppService</span><span class="token punctuation">(</span>
        <span class="token class-name">OrganizationManager</span> organizationManager<span class="token punctuation">,</span>
        <span class="token class-name">IPaymentService</span> paymentService<span class="token punctuation">,</span> 
        <span class="token class-name">IEmailSender</span> emailSender<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _organizationManager <span class="token operator">=</span> organizationManager<span class="token punctuation">;</span>
        _paymentService <span class="token operator">=</span> paymentService<span class="token punctuation">;</span>
        _emailSender <span class="token operator">=</span> emailSender<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">UnitOfWork</span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Authorize</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;OrganizationCreationPermission&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>Organization<span class="token punctuation">&gt;</span></span> <span class="token function">CreateAsync</span><span class="token punctuation">(</span><span class="token class-name">CreateOrganizationDto</span> input<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">await</span> _paymentService<span class="token punctuation">.</span><span class="token function">ChargeAsync</span><span class="token punctuation">(</span>
            CurrentUser<span class="token punctuation">.</span>Id<span class="token punctuation">,</span>
            <span class="token function">GetOrganizationPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> organization <span class="token operator">=</span> <span class="token keyword">await</span> _organizationManager<span class="token punctuation">.</span><span class="token function">CreateAsync</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">await</span> _organizationManager<span class="token punctuation">.</span><span class="token function">InsertAsync</span><span class="token punctuation">(</span>organization<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">await</span> _emailSender<span class="token punctuation">.</span><span class="token function">SendAsync</span><span class="token punctuation">(</span>
            <span class="token string">&quot;systemadmin@issuetracking.com&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;New Organization&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;A new organization created with name: &quot;</span> <span class="token operator">+</span> input<span class="token punctuation">.</span>Name
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> organization<span class="token punctuation">;</span> <span class="token comment">// !!!</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">double</span></span> <span class="token function">GetOrganizationPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">42</span><span class="token punctuation">;</span> <span class="token comment">//Gets from somewhere else...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>Let's see the <code>CreateAsync</code> method step by step to discuss if the code part should be in the Application Service, or not;</p> <ul><li><strong>CORRECT</strong>: Application Service methods should be unit of work (transactional). ABP's <a href="/blogs/2021/Abp/Unit-Of-Work.html">Unit Of Work</a> system makes this automatic (even without need to add <code>[UnitOfWork]</code> attribute for the Application Services).</li> <li><strong>CORRECT</strong>: <a href="/blogs/2021/Abp/Authorization.html">Authorization</a> should be done in the application layer. Here, it is done by using the <code>[Authorize]</code> attribute.</li> <li><strong>CORRECT</strong>: Payment (an infrastructure service) is called to charge money for this operation (Creating an Organization is a paid service in our business).</li> <li><strong>CORRECT</strong>: Application Service method is responsible to save changes to the database.</li> <li><strong>CORRECT</strong>: We can send <a href="/blogs/2021/Abp/Emailing.html">email</a> as a notification to the system admin.</li> <li><strong>WRONG</strong>: Do not return entities from the Application Services. Return a DTO instead.</li></ul> <p><strong>Discussion: Why don't we move the payment logic into the domain service?</strong></p> <p>You may wonder why the payment code is not inside the <code>OrganizationManager</code>. It is an <strong>important thing</strong> and we never want to <strong>miss the payment</strong>.</p> <p>However, <strong>being important is not sufficient</strong> to consider a code as a Core Business Logic. We may have <strong>other use cases</strong> where we don't charge money to create a new Organization. Examples;</p> <ul><li>An admin user can use a Back Office Application to create a new organization without any payment.</li> <li>A background-working data import/integration/synchronization system may also need to create organizations without any payment operation.</li></ul> <p>As you see, <strong>payment is not a necessary operation to create a valid organization</strong>. It is a use-case specific application logic.</p> <p><strong>Example: CRUD Operations</strong></p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IssueAppService</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IssueManager</span> _issueManager<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">IssueAppService</span><span class="token punctuation">(</span><span class="token class-name">IssueManager</span> issueManager<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _issueManager <span class="token operator">=</span> issueManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>IssueDto<span class="token punctuation">&gt;</span></span> <span class="token function">GetAsync</span><span class="token punctuation">(</span><span class="token class-name">Guid</span> id<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> _issueManager<span class="token punctuation">.</span><span class="token function">GetAsync</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">CreateAsync</span><span class="token punctuation">(</span><span class="token class-name">IssueCreationDto</span> input<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">await</span> _issueManager<span class="token punctuation">.</span><span class="token function">CreateAsync</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">UpdateAsync</span><span class="token punctuation">(</span><span class="token class-name">UpdateIssueDto</span> input<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">await</span> _issueManager<span class="token punctuation">.</span><span class="token function">UpdateAsync</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">DeleteAsync</span><span class="token punctuation">(</span><span class="token class-name">Guid</span> id<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">await</span> _issueManager<span class="token punctuation">.</span><span class="token function">DeleteAsync</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>This Application Service <strong>does nothing</strong> itself and <strong>delegates all the work</strong> to the <em>Domain Service</em>. It even passes the DTOs to the <code>IssueManager</code>.</p> <ul><li><strong>Do not</strong> create Domain Service methods just for simple <strong>CRUD</strong> operations <strong>without any domain logic</strong>.</li> <li><strong>Never</strong> pass <strong>DTOs</strong> to or return <strong>DTOs</strong> from the Domain Services.</li></ul> <p>Application Services can directly work with repositories to query, create, update or delete data unless there are some domain logics should be performed during these operations. In such cases, create Domain Service methods, but only for those really necessary.</p> <blockquote><p>Do not create such CRUD domain service methods just by thinking that they may be needed in the future (<a href="https://en.wikipedia.org/wiki/You_aren%27t_gonna_need_it" target="_blank" rel="noopener noreferrer">YAGNI<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)! Do it when you need and refactor the existing code. Since the Application Layer gracefully abstracts the Domain Layer, the refactoring process doesn't effect the UI Layer and other clients.</p></blockquote> <h2 id="reference-books"><a href="#reference-books" class="header-anchor">#</a> Reference Books</h2> <p>If you are more interested in the Domain Driven Design and building large-scale enterprise systems, the following books are recommended as reference books;</p> <ul><li>&quot;<em>Domain Driven Design</em>&quot; by Eric Evans</li> <li>&quot;<em>Implementing Domain Driven Design</em>&quot; by Vaughn Vernon</li> <li>&quot;<em>Clean Architecture</em>&quot; by Robert C. Martin</li></ul></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">2/24/2022, 3:11:39 PM</span></div></footer> <!----> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/blogs/2021/Abp/Domain-Driven-Design-Implementation-Guide.html#introduction" class="sidebar-link reco-side-introduction" data-v-b57cc07c>Introduction</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/2021/Abp/Domain-Driven-Design-Implementation-Guide.html#goals" class="sidebar-link reco-side-goals" data-v-b57cc07c>Goals</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/2021/Abp/Domain-Driven-Design-Implementation-Guide.html#simple-code" class="sidebar-link reco-side-simple-code" data-v-b57cc07c>Simple Code!</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/2021/Abp/Domain-Driven-Design-Implementation-Guide.html#what-is-the-domain-driven-design" class="sidebar-link reco-side-what-is-the-domain-driven-design" data-v-b57cc07c>What is the Domain Driven Design?</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/2021/Abp/Domain-Driven-Design-Implementation-Guide.html#oop-solid" class="sidebar-link reco-side-oop-solid" data-v-b57cc07c>OOP &amp; SOLID</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/2021/Abp/Domain-Driven-Design-Implementation-Guide.html#ddd-layers-clean-architecture" class="sidebar-link reco-side-ddd-layers-clean-architecture" data-v-b57cc07c>DDD Layers &amp; Clean Architecture</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/2021/Abp/Domain-Driven-Design-Implementation-Guide.html#core-building-blocks" class="sidebar-link reco-side-core-building-blocks" data-v-b57cc07c>Core Building Blocks</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/2021/Abp/Domain-Driven-Design-Implementation-Guide.html#implementation-the-big-picture" class="sidebar-link reco-side-implementation-the-big-picture" data-v-b57cc07c>Implementation: The Big Picture</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/2021/Abp/Domain-Driven-Design-Implementation-Guide.html#layering-of-a-net-solution" class="sidebar-link reco-side-layering-of-a-net-solution" data-v-b57cc07c>Layering of a .NET Solution</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/2021/Abp/Domain-Driven-Design-Implementation-Guide.html#dependencies-of-the-projects-in-the-solution" class="sidebar-link reco-side-dependencies-of-the-projects-in-the-solution" data-v-b57cc07c>Dependencies of the Projects in the Solution</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/2021/Abp/Domain-Driven-Design-Implementation-Guide.html#execution-flow-a-ddd-based-application" class="sidebar-link reco-side-execution-flow-a-ddd-based-application" data-v-b57cc07c>Execution Flow a DDD Based Application</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/2021/Abp/Domain-Driven-Design-Implementation-Guide.html#common-principles" class="sidebar-link reco-side-common-principles" data-v-b57cc07c>Common Principles</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/2021/Abp/Domain-Driven-Design-Implementation-Guide.html#implementation-the-building-blocks" class="sidebar-link reco-side-implementation-the-building-blocks" data-v-b57cc07c>Implementation: The Building Blocks</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/2021/Abp/Domain-Driven-Design-Implementation-Guide.html#the-example-domain" class="sidebar-link reco-side-the-example-domain" data-v-b57cc07c>The Example Domain</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/2021/Abp/Domain-Driven-Design-Implementation-Guide.html#aggregates" class="sidebar-link reco-side-aggregates" data-v-b57cc07c>Aggregates</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/2021/Abp/Domain-Driven-Design-Implementation-Guide.html#repositories" class="sidebar-link reco-side-repositories" data-v-b57cc07c>Repositories</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/2021/Abp/Domain-Driven-Design-Implementation-Guide.html#specifications" class="sidebar-link reco-side-specifications" data-v-b57cc07c>Specifications</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/2021/Abp/Domain-Driven-Design-Implementation-Guide.html#domain-services" class="sidebar-link reco-side-domain-services" data-v-b57cc07c>Domain Services</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/2021/Abp/Domain-Driven-Design-Implementation-Guide.html#application-services" class="sidebar-link reco-side-application-services" data-v-b57cc07c>Application Services</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/2021/Abp/Domain-Driven-Design-Implementation-Guide.html#data-transfer-objects" class="sidebar-link reco-side-data-transfer-objects" data-v-b57cc07c>Data Transfer Objects</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/2021/Abp/Domain-Driven-Design-Implementation-Guide.html#example-use-cases" class="sidebar-link reco-side-example-use-cases" data-v-b57cc07c>Example Use Cases</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/2021/Abp/Domain-Driven-Design-Implementation-Guide.html#entity-creation" class="sidebar-link reco-side-entity-creation" data-v-b57cc07c>Entity Creation</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/2021/Abp/Domain-Driven-Design-Implementation-Guide.html#updating-manipulating-an-entity" class="sidebar-link reco-side-updating-manipulating-an-entity" data-v-b57cc07c>Updating / Manipulating An Entity</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/2021/Abp/Domain-Driven-Design-Implementation-Guide.html#domain-logic-application-logic" class="sidebar-link reco-side-domain-logic-application-logic" data-v-b57cc07c>Domain Logic &amp; Application Logic</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/2021/Abp/Domain-Driven-Design-Implementation-Guide.html#multiple-application-layers" class="sidebar-link reco-side-multiple-application-layers" data-v-b57cc07c>Multiple Application Layers</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/2021/Abp/Domain-Driven-Design-Implementation-Guide.html#examples" class="sidebar-link reco-side-examples" data-v-b57cc07c>Examples</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/2021/Abp/Domain-Driven-Design-Implementation-Guide.html#reference-books" class="sidebar-link reco-side-reference-books" data-v-b57cc07c>Reference Books</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><!----><div class="kanbanniang" data-v-5775ee02><div class="banniang-container" style="display:;" data-v-5775ee02><div class="messageBox" style="right:68px;bottom:190px;display:none;" data-v-5775ee02>
      欢迎来到KB - GerryGe的博客
    </div> <div class="operation" style="right:90px;bottom:40px;display:;" data-v-5775ee02><i class="kbnfont kbn-ban-home ban-home" data-v-5775ee02></i> <i class="kbnfont kbn-ban-message message" data-v-5775ee02></i> <i class="kbnfont kbn-ban-close close" data-v-5775ee02></i> <a target="_blank" href="https://vuepress-theme-reco.recoluan.com/views/plugins/kanbanniang.html" data-v-5775ee02><i class="kbnfont kbn-ban-info info" data-v-5775ee02></i></a> <i class="kbnfont kbn-ban-theme skin" style="display:;" data-v-5775ee02></i></div> <canvas id="banniang" width="150" height="220" class="live2d" style="right:90px;bottom:-20px;opacity:0.9;" data-v-5775ee02></canvas></div> <div class="showBanNiang" style="display:none;" data-v-5775ee02>
    看板娘
  </div></div></div></div>
    <script src="/assets/js/app.ef01f0fb.js" defer></script><script src="/assets/js/4.1a620e6f.js" defer></script><script src="/assets/js/1.0577eaba.js" defer></script><script src="/assets/js/8.944d7199.js" defer></script>
  </body>
</html>
