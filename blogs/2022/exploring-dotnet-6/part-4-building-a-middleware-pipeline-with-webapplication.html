<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>使用 WebApplication 构建中间件管道 | Knowledge Base - 个人技术分享</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/favicon.ico">
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?b2f6c180e095d06a0231b882e58fc0e7";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
        </script>
    <meta name="description" content="全栈开发工程师">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.3b030fed.css" as="style"><link rel="preload" href="/assets/js/app.ef01f0fb.js" as="script"><link rel="preload" href="/assets/js/4.1a620e6f.js" as="script"><link rel="preload" href="/assets/js/1.0577eaba.js" as="script"><link rel="preload" href="/assets/js/9.bb509c3d.js" as="script"><link rel="prefetch" href="/assets/js/10.04409825.js"><link rel="prefetch" href="/assets/js/11.c28078a7.js"><link rel="prefetch" href="/assets/js/12.af2f9992.js"><link rel="prefetch" href="/assets/js/13.0ea175ca.js"><link rel="prefetch" href="/assets/js/14.32bb99d4.js"><link rel="prefetch" href="/assets/js/15.97406a87.js"><link rel="prefetch" href="/assets/js/16.bbba74dd.js"><link rel="prefetch" href="/assets/js/17.a62fdaff.js"><link rel="prefetch" href="/assets/js/18.64c4677c.js"><link rel="prefetch" href="/assets/js/19.61e64f4b.js"><link rel="prefetch" href="/assets/js/20.1e3f3933.js"><link rel="prefetch" href="/assets/js/21.6b13545c.js"><link rel="prefetch" href="/assets/js/22.f5e49336.js"><link rel="prefetch" href="/assets/js/23.b3faa685.js"><link rel="prefetch" href="/assets/js/24.5639c7cc.js"><link rel="prefetch" href="/assets/js/25.0e3a9f75.js"><link rel="prefetch" href="/assets/js/26.0ae5f6e7.js"><link rel="prefetch" href="/assets/js/27.e185fb99.js"><link rel="prefetch" href="/assets/js/28.cf8b14c6.js"><link rel="prefetch" href="/assets/js/29.37b05781.js"><link rel="prefetch" href="/assets/js/30.1be0771e.js"><link rel="prefetch" href="/assets/js/31.8de5ead7.js"><link rel="prefetch" href="/assets/js/32.189e473f.js"><link rel="prefetch" href="/assets/js/33.6e0105ce.js"><link rel="prefetch" href="/assets/js/34.1757f1fa.js"><link rel="prefetch" href="/assets/js/35.a6082629.js"><link rel="prefetch" href="/assets/js/36.88fcb004.js"><link rel="prefetch" href="/assets/js/37.0b70b7dc.js"><link rel="prefetch" href="/assets/js/38.8eba7c80.js"><link rel="prefetch" href="/assets/js/39.2aa44bb2.js"><link rel="prefetch" href="/assets/js/40.55c62c88.js"><link rel="prefetch" href="/assets/js/5.47a6f0e4.js"><link rel="prefetch" href="/assets/js/6.f15cba4a.js"><link rel="prefetch" href="/assets/js/7.b297844b.js"><link rel="prefetch" href="/assets/js/8.944d7199.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.a4c136e5.js">
    <link rel="stylesheet" href="/assets/css/0.styles.3b030fed.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>Knowledge Base - 个人技术分享</h3> <p class="description" data-v-59e6cb88>全栈开发工程师</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>Gerry Ge</span>
          
        <span data-v-59e6cb88>2019 - </span>
        2023
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="Knowledge Base - 个人技术分享" class="logo"> <span class="site-name">Knowledge Base - 个人技术分享</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/ABP/" class="nav-link"><i class="undefined"></i>
  ABP
</a></li><li class="dropdown-item"><!----> <a href="/categories/MICROSERVICE/" class="nav-link"><i class="undefined"></i>
  MICROSERVICE
</a></li><li class="dropdown-item"><!----> <a href="/categories/DDD/" class="nav-link"><i class="undefined"></i>
  DDD
</a></li><li class="dropdown-item"><!----> <a href="/categories/.NET/" class="nav-link"><i class="undefined"></i>
  .NET
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  Time Line
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/gerryge" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/avatar.png" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    Gerry Ge
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>26</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>5</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/ABP/" class="nav-link"><i class="undefined"></i>
  ABP
</a></li><li class="dropdown-item"><!----> <a href="/categories/MICROSERVICE/" class="nav-link"><i class="undefined"></i>
  MICROSERVICE
</a></li><li class="dropdown-item"><!----> <a href="/categories/DDD/" class="nav-link"><i class="undefined"></i>
  DDD
</a></li><li class="dropdown-item"><!----> <a href="/categories/.NET/" class="nav-link"><i class="undefined"></i>
  .NET
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  Time Line
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/gerryge" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>探索 .NET 6 系列</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blogs/2022/exploring-dotnet-6/" aria-current="page" class="sidebar-link">系列： 探索 .NET 6</a></li><li><a href="/blogs/2022/exploring-dotnet-6/part-1-looking-inside-configurationmanager-in-dotnet-6.html" class="sidebar-link">探索 .NET 6 中的 ConfigurationManager</a></li><li><a href="/blogs/2022/exploring-dotnet-6/part-2-comparing-webapplicationbuilder-to-the-generic-host.html" class="sidebar-link">比较 WebApplicationBuilder 和 Generic Host</a></li><li><a href="/blogs/2022/exploring-dotnet-6/part-3-exploring-the-code-behind-webapplicationbuilder.html" class="sidebar-link">探索 WebApplicationBuilder 背后的代码</a></li><li><a href="/blogs/2022/exploring-dotnet-6/part-4-building-a-middleware-pipeline-with-webapplication.html" aria-current="page" class="active sidebar-link">使用 WebApplication 构建中间件管道</a></li><li><a href="/blogs/2022/exploring-dotnet-6/part-5-supporting-ef-core-tools-with-webapplicationbuilder.html" class="sidebar-link">使用 WebApplicationBuilder 支持 EF Core 迁移</a></li><li><a href="/blogs/2022/exploring-dotnet-6/part-6-supporting-integration-tests-with-webapplicationfactory-in-dotnet-6.html" class="sidebar-link">在 .NET 6 中使用 WebApplicationFactory 支持集成测试</a></li><li><a href="/blogs/2022/exploring-dotnet-6/part-7-analyzers-for-minimal-apis.html" class="sidebar-link">用于 .NET 6 中的 ASP.NET Core 分析器</a></li><li><a href="/blogs/2022/exploring-dotnet-6/part-8-improving-logging-performance-with-source-generators.html" class="sidebar-link">使用源代码生成器提高日志记录性能</a></li><li><a href="/blogs/2022/exploring-dotnet-6/part-9-source-generator-updates-incremental-generators.html" class="sidebar-link">源代码生成器更新：增量生成器</a></li><li><a href="/blogs/2022/exploring-dotnet-6/part-10-new-dependency-injection-features-in-dotnet-6.html" class="sidebar-link">.NET 6 中新的依赖关系注入功能</a></li><li><a href="/blogs/2022/exploring-dotnet-6/part-11-callerargumentexpression-and-throw-helpers.html" class="sidebar-link">CallerArgumentExpression 和 throw helpers</a></li><li><a href="/blogs/2022/exploring-dotnet-6/part-12-upgrading-a-dotnet-5-startup-based-app-to-dotnet-6.html" class="sidebar-link">将基于 .NET 5 启动版本的应用升级到 .NET 6</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>使用 WebApplication 构建中间件管道</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>Gerry Ge</span>
          
        <span data-v-59e6cb88>2019 - </span>
        2023
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">使用 WebApplication 构建中间件管道</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>Gerry Ge</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>3/11/2022</span></i> <!----> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>.NET6</span></i></div></div> <div class="theme-reco-content content__default"><p>这是该系列的第四篇文章：<a href="/blogs/2022/exploring-dotnet-6/" class="router-link-active">探索 .NET 6</a>。</p> <p>在<a href="./part-3-exploring-the-code-behind-webapplicationbuilder">我之前的文章中</a>，我们查看了 <code>WebApplicationBuilder</code> 背后的代码，包括它的一些帮助器类，如 <code>ConservationHostBuilder</code> 和 <code>BootstrapHostBuilder</code>。在文章的最后，我们创建了一个 <code>WebApplicationBuilder</code> 的实例，并调用 <code>Build</code>() 来创建一个 <code>WebApplication</code>。在这篇文章中，我们将介绍 <code>WebApplication</code> 背后的一些代码，并重点介绍中间件和终结点的配置方式。</p> <h2 id="webapplication-简要回顾"><a href="#webapplication-简要回顾" class="header-anchor">#</a> WebApplication：简要回顾</h2> <p>这篇文章是<a href="./part-3-exploring-the-code-behind-webapplicationbuilder">上一篇关于 <code>WebApplicationBuilder</code> 的文章</a>，以及 <a href="./part-2-comparing-webapplicationbuilder-to-the-generic-host"><code>WebApplication</code> 的介绍</a>的延续，所以我建议你从这些帖子开始，如果你还没有读过它们。也就是说，与上一篇文章相比，我不会在这篇文章中深入代码！</p> <p>正如我在<a href="/blogs/2022/exploring-dotnet-6/part-2-comparing-webapplicationbuilder-to-the-generic-host.html#webapplication-担任多项任务">之前文章中</a>所描述的那样，<code>WebApplicationBuilder</code> 是您进行大部分应用程序配置的地方，而 <code>WebApplication</code> 用于三个不同的事情：</p> <ul><li>这是您配置中间件管道的地方，因为它实现了 <code>IApplicationBuilder</code>。</li> <li>这是您使用<code>MapGet()</code>，<code>MapRazorPages()</code> 等配置终结点的地方，因为它实现了<code>IEndpointRouteBuilder</code>。</li> <li>这是您通过调用 <code>Run</code>() 来实际启动应用程序所运行的内容，因为它实现了 <code>IHost</code>。</li></ul> <p>在<a href="/blogs/2022/exploring-dotnet-6/part-3-exploring-the-code-behind-webapplicationbuilder.html#使用-webapplicationbuilder-build-构建-webapplication">上一篇文章的末尾</a>，我们看到当您在 <code>WebApplicationBuilder</code> 实例上调用 <code>Build()</code> 时，将创建通用主机 <code>Host</code> 的私有实例，并将其传递给 <code>WebApplication</code> 构造函数。这篇文章就是从这里开始继续，在我们开始研究中间件管道之前，先对 <code>WebApplication</code> 有一点了解。</p> <h2 id="webapplication-围绕三种类型的相对简单的包装器。"><a href="#webapplication-围绕三种类型的相对简单的包装器。" class="header-anchor">#</a> WebApplication：围绕三种类型的相对简单的包装器。</h2> <p>与 <code>WebApplicationBuilder</code> 构造函数相比，<code>WebApplication</code> 构造函数相对简单：</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">WebApplication</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IHost</span><span class="token punctuation">,</span> <span class="token class-name">IApplicationBuilder</span><span class="token punctuation">,</span> <span class="token class-name">IEndpointRouteBuilder</span><span class="token punctuation">,</span> <span class="token class-name">IAsyncDisposable</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IHost</span> _host<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">List<span class="token punctuation">&lt;</span>EndpointDataSource<span class="token punctuation">&gt;</span></span> _dataSources <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">internal</span> <span class="token return-type class-name">IDictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token punctuation">?</span><span class="token punctuation">&gt;</span></span> Properties <span class="token operator">=&gt;</span> ApplicationBuilder<span class="token punctuation">.</span>Properties<span class="token punctuation">;</span>

    <span class="token keyword">internal</span> <span class="token keyword">static</span> <span class="token class-name"><span class="token keyword">string</span></span> GlobalEndpointRouteBuilderKey <span class="token operator">=</span> <span class="token string">&quot;__GlobalEndpointRouteBuilder&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">internal</span> <span class="token function">WebApplication</span><span class="token punctuation">(</span><span class="token class-name">IHost</span> host<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _host <span class="token operator">=</span> host<span class="token punctuation">;</span>
        ApplicationBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ApplicationBuilder</span><span class="token punctuation">(</span>host<span class="token punctuation">.</span>Services<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Properties<span class="token punctuation">[</span>GlobalEndpointRouteBuilderKey<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>构造函数和字段初始值设定项主要执行 4 项操作：</p> <ul><li>在 <code>_host</code> 字段中保存提供的 <code>Host</code>。这与 ASP.NET Core 3.x/5 中使用通用主机时所使用的 <code>Host</code> 类型相同。</li> <li>创建 <code>EndpointDataSource</code> 的新列表。这些用于配置应用程序中的终结点，包括 Razor 页面、控制器、API 终结点和新的&quot;最小&quot; <em>APIs</em>。</li> <li>创建 <code>ApplicationBuilder</code> 的新实例。这用于构建中间件管道，并且基本上与自版本 1.0 以来使用的类型相同！</li> <li>在 <code>ApplicationBuilder</code> 上设置 <code>__GlobalEndpointRouteBuilder</code> 属性。此属性用于&quot;通信&quot;到我们正在使用新 <code>WebApplication</code> 的其他中间件，它具有一些不同的默认值，稍后您将看到。</li></ul> <p><code>WebApplication</code> 主要将 <code>IHost</code>、<code>IApplicationBuilder</code> 和 <code>IEndpointRouteBuilder</code> 的实现委托给其私有属性，并显式实现它们。例如，对于 <code>IApplicationBuilder</code>，大部分实现都委托给在构造函数中创建的 <code>ApplicationBuilder</code>：</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token return-type class-name">IDictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token punctuation">?</span><span class="token punctuation">&gt;</span></span> IApplicationBuilder<span class="token punctuation">.</span>Properties <span class="token operator">=&gt;</span> ApplicationBuilder<span class="token punctuation">.</span>Properties<span class="token punctuation">;</span>

<span class="token return-type class-name">IServiceProvider</span> IApplicationBuilder<span class="token punctuation">.</span>ApplicationServices
<span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token operator">=&gt;</span> ApplicationBuilder<span class="token punctuation">.</span>ApplicationServices<span class="token punctuation">;</span>
    <span class="token keyword">set</span> <span class="token operator">=&gt;</span> ApplicationBuilder<span class="token punctuation">.</span>ApplicationServices <span class="token operator">=</span> <span class="token keyword">value</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token return-type class-name">IApplicationBuilder</span> IApplicationBuilder<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="token class-name">Func<span class="token punctuation">&lt;</span>RequestDelegate<span class="token punctuation">,</span> RequestDelegate<span class="token punctuation">&gt;</span></span> middleware<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    ApplicationBuilder<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>middleware<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>有趣的是，当您调用 <code>RunAsync()</code> 时，它会构建中间件管道。</p> <h2 id="启动-webapplication-并构建中间件管道"><a href="#启动-webapplication-并构建中间件管道" class="header-anchor">#</a> 启动 WebApplication 并构建中间件管道</h2> <p>启动应用程序的标准方法是在 <code>WebApplication</code> 上调用 <code>app.Run()</code>。这将调用 <code>WebApplication.RunAsync</code>，后者又调用 <code>IHost</code> 扩展方法<code>HostingAbstractionsHostExtensions.RunAsync()</code>，该方法与 3.x/5 中与通用主机一起使用的方法相同。这反过来又调用了 <code>IHost.StartAsync</code>，它启动了<a href="https://andrewlock.net/introducing-ihostlifetime-and-untangling-the-generic-host-startup-interactions/" target="_blank" rel="noopener noreferrer">我之前写过的复杂的启动交互<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p><img src="/assets/img/hosting_startup.f5125629.png" alt="Sequence diagram for Host.StartAsync()"></p> <p>如上图所示，<code>Host</code> 运行在应用程序中注册的 <code>IHostedService</code>，作为启动序列的一部分。从 ASP.NET Core 3.x 中的&quot;伟大的重新平台化&quot;开始，Web 服务器也作为 <code>IHostedService</code> 运行，所以这是构建中间件管道并开始侦听的时候。</p> <p><code>GenericWebHostService</code> 是构建中间件管道的地方，最后传递给 Kestrel 以运行您的应用程序。与通用主机相比，<code>WebApplication</code> 在此过程中没有什么不同，因此，我们将介绍<code>WebApplication</code> 如何设置中间件管道，而不是深入研究（广泛的！）代码。</p> <h2 id="webapplication-的中间件管道"><a href="#webapplication-的中间件管道" class="header-anchor">#</a> WebApplication 的中间件管道</h2> <p>与通用主机相比，<code>WebApplication</code> 的一大区别是 <code>WebApplication</code> 默认设置各种中间件。在<a href="/blogs/2022/exploring-dotnet-6/part-3-exploring-the-code-behind-webapplicationbuilder.html#webapplicationbuilder-构造器">上一篇文章中</a>，我展示了 <code>WebApplicationBuilder</code> 调用<code>GenericHostBuilderExtensions.ConfigureWebHostDefaults()</code>。这也通常与通用主机一起使用，并设置了几个默认值：</p> <ul><li>配置 Kestrel</li> <li>添加 <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/servers/kestrel/host-filtering?view=aspnetcore-5.0" target="_blank" rel="noopener noreferrer"><code>HostFiltering</code> 中间件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>如果 <code>ASPNETCORE_FORWARDEDHEADERS_ENABLED</code> 环境变量设置为 <code>true</code>，则添加 <a href="https://devblogs.microsoft.com/dotnet/forwarded-headers-middleware-updates-in-net-core-3-0-preview-6/" target="_blank" rel="noopener noreferrer"><code>ForwardedHeaders</code> 中间件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</li> <li>支持 IIS 集成</li></ul> <p>除此之外，<code>WebApplicationBuilder</code> 还设置了额外的中间件。这就是我在<a href="/blogs/2022/exploring-dotnet-6/part-3-exploring-the-code-behind-webapplicationbuilder.html#webapplicationbuilder-构造器">上一篇文章中提到的配置应用程序方法</a>的用武之地。根据您配置 <code>WebApplication</code> 的方式，<code>ConfigureApplication</code> 会向管道添加其他中间件。</p> <p>此代码有点复杂，因为它需要处理多个边缘情况。与其尝试过于详细地跟踪代码，不如看一些示例，看看生成的中间件管道是什么样子的。</p> <h3 id="空管道"><a href="#空管道" class="header-anchor">#</a> 空管道</h3> <p>我们将从最基本（且有些无意义）的应用程序开始，其中我们不会向应用程序添加任何额外的中间件或终结点：</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token class-name">WebApplicationBuilder</span> builder <span class="token operator">=</span> WebApplication<span class="token punctuation">.</span><span class="token function">CreateBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">WebApplication</span> app <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>此设置是最基本的配置，并生成一个中间件管道，其中包含：</p> <ul><li><code>HostFilteringMiddleware</code></li> <li><code>DeveloperExceptionPageMiddleware</code></li> <li>从 <code>WebApplication</code> 的 <code>ApplicationBuilder</code> 构建的&quot;空&quot;中间件。</li></ul> <p>如下所示：</p> <p><img src="data:image/png;base64,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" alt="The WebApplication adds the DeveloperExceptionPageMiddleware by default"></p> <p><code>HostFilteringMiddleware</code> 是由于对 <code>ConfigureWebHostDefaults</code>() 的隐藏调用而添加的，如上一节所述。未添加 <code>ForwardedHeadersMiddleware</code>，因为未添加环境变量。</p> <p>现在，当您在开发环境中运行时，会自动添加 <code>DeveloperExceptionPage</code>，并将以下内容添加到每个中间件管道的开头：</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>HostingEnvironment<span class="token punctuation">.</span><span class="token function">IsDevelopment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    app<span class="token punctuation">.</span><span class="token function">UseDeveloperExceptionPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>管道中的最后一块中间件是使用直接添加到 <code>Program.cs</code> 中的 <code>WebApplication</code> 的 <code>ApplicationBuilder</code> 的中间件构建的。在此示例中，我们没有添加任何内容，因此我们实质上是在中间件内部添加了一个&quot;空&quot;管道。</p> <p>显然，仅具有默认中间件的应用程序没有多大用处，因此让我们做一些基本的并向<code>WebApplication</code> 添加一些中间件。</p> <h3 id="具有额外中间件的管道"><a href="#具有额外中间件的管道" class="header-anchor">#</a> 具有额外中间件的管道</h3> <p>在此示例中，我们将一些其他中间件添加到管道中：静态文件中间件和 HTTPS 重定向中间件：</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token class-name">WebApplicationBuilder</span> builder <span class="token operator">=</span> WebApplication<span class="token punctuation">.</span><span class="token function">CreateBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">WebApplication</span> app <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 添加一些额外的中间件</span>
app<span class="token punctuation">.</span><span class="token function">UseHttpsRedirection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">UseStaticFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>通过此设置，我们仍然拥有与上一节中相同的三核中间件，但 <code>WebApplication.ApplicationBuilder</code> 管道现在包含两个额外的中间件</p> <ul><li><code>HostFilteringMiddleware</code></li> <li><code>DeveloperExceptionPageMiddleware</code></li> <li><code>WebApplication.ApplicationBuilder</code> 管道，包含
<ul><li><code>HttpsRedirectionMiddleware</code></li> <li><code>StaticFilesMiddleware</code></li></ul></li></ul> <p>所以现在我们有一个看起来像这样的东西：</p> <p><img src="/assets/img/webapplication2.e213a50c.png" alt="The WebApplication.ApplicationBuilder pipeline includes the middleware added directly to the WebApplication"></p> <p>我们仍然没有任何终结点，因此在下一个示例中，我们实现了一个 &quot;Hello World！&quot; 终结点 ：</p> <h3 id="hello-world-管道"><a href="#hello-world-管道" class="header-anchor">#</a> &quot;Hello World&quot; 管道</h3> <p>在下面的示例中，我们为主页添加了一个终结点，该终结点将文本 &quot;Hello World！&quot; 返回到我在上一个示例中显示的示例中：</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token class-name">WebApplicationBuilder</span> builder <span class="token operator">=</span> WebApplication<span class="token punctuation">.</span><span class="token function">CreateBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">WebApplication</span> app <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">UseHttpsRedirection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">UseStaticFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 添加单个终节点</span>
app<span class="token punctuation">.</span><span class="token function">MapGet</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;Hello World!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>使用 <code>MapGet()</code> 添加终结点会将一个入口添加到 <code>WebApplication</code> 的 <code>EndpointDataSource</code> 集合中，这会导致 <code>ConfigureApplication</code> 自动添加其他中间件：</p> <ul><li><p><code>HostFilteringMiddleware</code></p></li> <li><p><code>DeveloperExceptionPageMiddleware</code></p></li> <li><p><code>EndpointRoutingMiddleware</code> （又名 <code>RoutingMiddleware</code>）</p></li> <li><p><code>WebApplication.ApplicationBuilder</code> 管道，包含</p> <ul><li><code>HttpsRedirectionMiddleware</code></li> <li><code>StaticFilesMiddleware</code></li></ul></li> <li><p><code>EndpointMiddleware</code></p></li></ul> <p>请注意，在 <em>Program.cs</em> 中定义的管道开始之前，<code>RoutingMiddleware</code> 会自动添加到中间件管道中，并且 <code>EndpointMiddleware</code> 会自动添加到管道末尾。生成的管道如下所示：</p> <p><img src="/assets/img/webapplication3.903f32ef.png" alt="The WebApplication has added the the RoutingMiddleware and EndpointMiddleware to the pipeline"></p> <p>我发现非常有趣的是，<code>WebApplication</code> 对用户隐藏了路由中间件。<code>RoutingMiddleware</code> 和 <code>EndpointMiddleware</code> 密切相关，并且它们施加了严格的排序要求（例如，<code>AuthorizationMiddleware</code> 必须放在它们之间），这使得它们成为新手相对难以掌握的概念。使用 .NET 6 和 <code>WebApplication</code>，用户需要担心的事情更少了！</p> <blockquote><p>不过，这并不都是美好的。一些中间件通常假设它将在 <code>UseRouting()</code> 之前被调用。例如，<code>ExceptionHandlerMiddleware</code>、<code>RewriterMiddleware</code>、<code>StatusCodePagesMiddleware</code> <a href="https://github.com/dotnet/aspnetcore/pull/35426" target="_blank" rel="noopener noreferrer">都必须更新才能处理这种新模式<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p></blockquote> <p>但是，如果您需要 <code>RoutingMiddleware</code> 位于管道中的特定点，该怎么办？例如，也许您有中间件需要在<code>RoutingMiddleware</code> 之前？</p> <h3 id="具有-userouting-的管道"><a href="#具有-userouting-的管道" class="header-anchor">#</a> 具有 UseRouting() 的管道</h3> <p>在下一个示例中，我们通过调用 <code>UseRouting()</code> 将 <code>EndpointRoutingMiddleware</code> 显式添加到 <code>WebApplication.ApplicationBuilder</code> 管道中。这更接近于您希望在 .NET 3.x/5 应用中看到的内容，其中 <code>UseRouting()</code> 位于管道的<em>中间</em>。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token class-name">WebApplicationBuilder</span> builder <span class="token operator">=</span> WebApplication<span class="token punctuation">.</span><span class="token function">CreateBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">WebApplication</span> app <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">UseHttpsRedirection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">UseStaticFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// EndpointRoutingMiddleware 位于管道的中间</span>
app<span class="token punctuation">.</span><span class="token function">UseRouting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">MapGet</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;Hello World!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>如您所料，生成的管道包含与以前相同的所有中间件，但排列顺序略有不同：</p> <ul><li><p><code>HostFilteringMiddleware</code></p></li> <li><p><code>DeveloperExceptionPageMiddleware</code></p></li> <li><p><code>WebApplication.ApplicationBuilder</code> 管道，包含</p> <ul><li><code>HttpsRedirectionMiddleware</code></li> <li><code>StaticFilesMiddleware</code></li> <li><code>EndpointRoutingMiddleware</code> （<code>RoutingMiddleware</code>）</li></ul></li> <li><p><code>EndpointMiddleware</code></p></li></ul> <p>这可以被可视化成这样：</p> <p><img src="/assets/img/webapplication4.0647bf67.png" alt="The middleware pipeline contains the RoutingMiddleware in the WebApplication.ApplicationBuilder"></p> <p>在&quot;主&quot;中间件管道和 <code>WebApplication.ApplicationBuilder</code> 管道之间有<a href="https://github.com/dotnet/aspnetcore/blob/fb05933145108588a38007f57d073aed50e66614/src/DefaultBuilder/src/WebApplicationBuilder.cs#L248-L263" target="_blank" rel="noopener noreferrer">一个有趣的相互作用<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，在指定 <code>UseRouting()</code> 时，<code>WebApplicationBuilder</code> 必须小心地保留整体顺序。希望这不会经常被需要，但是当真的需要时，如果您愿意，您仍然应该能够使用 <code>WebApplicationBuilder</code>，而不是被迫回退到通用主机。</p> <p>最后，让我们看一下如果添加终结点路由的另一端终结点（<code>EndpointMiddleware</code>）会发生什么情况。</p> <h3 id="具有-useendpoints-的管道"><a href="#具有-useendpoints-的管道" class="header-anchor">#</a> 具有 UseEndpoints() 的管道</h3> <p>如前所述，终结点路由适用于一对中间件，即<em>选择</em>终结点的 <code>EndpointRoutingMiddleware</code>（又名 <code>RoutingMiddleware</code>）和<em>执行</em>终结点的 <code>EndpointMiddleware</code>。<code>EndpointMiddleware</code> 通常通过调用 <code>UseEndpoints</code> 添加到管道中，但使用 <code>WebApplicationBuilder</code>，它会自动添加。让我们看看如果我们也显式添加它会发生什么。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token class-name">WebApplicationBuilder</span> builder <span class="token operator">=</span> WebApplication<span class="token punctuation">.</span><span class="token function">CreateBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">WebApplication</span> app <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">UseHttpsRedirection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">UseStaticFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">UseRouting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">MapGet</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;Hello World!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 显式添加终结点中间件，并添加一个新的终结点</span>
app<span class="token punctuation">.</span><span class="token function">UseEndpoints</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> 
<span class="token punctuation">{</span>
    x<span class="token punctuation">.</span><span class="token function">MapGet</span><span class="token punctuation">(</span><span class="token string">&quot;/ping&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;pong&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>使用上述配置，您最终会得到以下内容：</p> <ul><li><p><code>HostFilteringMiddleware</code></p></li> <li><p><code>DeveloperExceptionPageMiddleware</code></p></li> <li><p><code>WebApplication.ApplicationBuilder</code> 管道，包含</p> <ul><li><code>HttpsRedirectionMiddleware</code></li> <li><code>StaticFilesMiddleware</code></li> <li><code>EndpointRoutingMiddleware</code> （<code>RoutingMiddleware</code>）,和</li> <li><code>EndpointMiddleware</code></li></ul></li> <li><p><code>EndpointMiddleware</code></p></li></ul> <p>如果您仔细阅读上面的列表，您会发现终结点中间件出现了两次！这不是一个错误，<a href="https://github.com/dotnet/aspnetcore/blob/fb05933145108588a38007f57d073aed50e66614/src/DefaultBuilder/src/WebApplicationBuilder.cs#L272-L276" target="_blank" rel="noopener noreferrer">而是 <code>WebApplicationBuilder</code> 无法判断 <code>EndpointMiddleware</code> 是否被添加到 <code>WebApplication.ApplicationBuilder</code> 管道中<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的结果。幸运的是，&quot;外部&quot;中间件是完全良性的。</p> <p><img src="/assets/img/webapplication5.03e486d1.png" alt="The middleware pipeline contains two instances of the EndpointMiddleware"></p> <p>您可能还会注意到，我<em>直接</em>在 <code>WebApplication</code> 上以及在 <code>UseEndpoints()</code> 调用中注册了终结点。但是，这些终结点都已注册到 <code>WebApplication</code> 的 <code>_dataSources</code>，<a href="https://github.com/dotnet/aspnetcore/blob/fb05933145108588a38007f57d073aed50e66614/src/DefaultBuilder/src/WebApplicationBuilder.cs#L248-L263" target="_blank" rel="noopener noreferrer">这要归功于 <code>WebApplicationBuilder</code> 中属性的一些诡计多端的摆弄<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。最终结果是永远不会调用第二个中间件。</p> <p>这涵盖了与在 <code>WebApplication</code> 中构建中间件管道相关的大多数边缘情况。我认为看到这里所做的更改非常有趣，尽管正如<a href="./part-2-comparing-webapplicationbuilder-to-the-generic-host">我之前提到的</a>，我希望在 <code>WebApplication</code> 中的中间件和终结点之间有更好的划分。例如，我希望它看起来更像这样：</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token class-name">WebApplicationBuilder</span> builder <span class="token operator">=</span> WebApplication<span class="token punctuation">.</span><span class="token function">CreateBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">WebApplication</span> app <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">UseHttpsRedirection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">UseStaticFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">UseRouting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// I wish the &quot;Endpoints&quot; property was a thing</span>
app<span class="token punctuation">.</span>Endpoints<span class="token punctuation">.</span><span class="token function">MapGet</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;Hello World!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span>Endpoints<span class="token punctuation">.</span><span class="token function">MapGet</span><span class="token punctuation">(</span><span class="token string">&quot;/ping&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;pong&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>但就目前而言，不可否认的是，<code>WebApplication</code> 和 <code>WebApplicationBuilder</code> 提供了比它们包装的通用主机实现更简单的API。希望这样可以更容易地教给新手！</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>在这篇文章中，我们看到了新的&quot;最小托管&quot; <code>WebApplication</code> 如何为您的应用程序构建中间件管道。我们首先查看了 <code>WebAppliation</code> 的构造函数，以了解它的工作原理，然后查看了一些示例管道。对于每个管道，我都显示了您编写的代码以及生成的中间件管道。这显示了 <code>WebApplication</code> 如何自动（有条件地）在管道的开头添加 <code>DeveloperExceptionPageMiddleware</code>，并将管道包装在路由中间件中。总体而言，这可以简化中间件排序问题，但最好了解正在发生的事情。</p> <p>实现最小托管 API 需要对中间件进行大量更改以适应新模式。在下一篇文章中，我们将介绍 .NET Core 中必须更改的其他一些内容！</p> <br> <br> <br> <div class="custom-block warning"><p class="title"></p><p>作者：Gerry Ge</p> <p>出处：翻译至 <a href="https://andrewlock.net/exploring-dotnet-6-part-4-building-a-middleware-pipeline-with-webapplication/" target="_blank" rel="noopener noreferrer">Building a middleware pipeline with WebApplication<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>版权：本作品采用「<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener noreferrer">署名-非商业性使用-相同方式共享 4.0 国际<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>」许可协议进行许可。</p> <p><strong>转载请注明出处</strong></p></div></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">3/16/2022, 8:52:03 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/blogs/2022/exploring-dotnet-6/part-3-exploring-the-code-behind-webapplicationbuilder.html" class="prev">
          探索 WebApplicationBuilder 背后的代码
        </a></span> <span class="next"><a href="/blogs/2022/exploring-dotnet-6/part-5-supporting-ef-core-tools-with-webapplicationbuilder.html">
          使用 WebApplicationBuilder 支持 EF Core 迁移
        </a></span></p></div> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/blogs/2022/exploring-dotnet-6/part-4-building-a-middleware-pipeline-with-webapplication.html#webapplication-简要回顾" class="sidebar-link reco-side-webapplication-简要回顾" data-v-b57cc07c>WebApplication：简要回顾</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/2022/exploring-dotnet-6/part-4-building-a-middleware-pipeline-with-webapplication.html#webapplication-围绕三种类型的相对简单的包装器。" class="sidebar-link reco-side-webapplication-围绕三种类型的相对简单的包装器。" data-v-b57cc07c>WebApplication：围绕三种类型的相对简单的包装器。</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/2022/exploring-dotnet-6/part-4-building-a-middleware-pipeline-with-webapplication.html#启动-webapplication-并构建中间件管道" class="sidebar-link reco-side-启动-webapplication-并构建中间件管道" data-v-b57cc07c>启动 WebApplication 并构建中间件管道</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/2022/exploring-dotnet-6/part-4-building-a-middleware-pipeline-with-webapplication.html#webapplication-的中间件管道" class="sidebar-link reco-side-webapplication-的中间件管道" data-v-b57cc07c>WebApplication 的中间件管道</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/2022/exploring-dotnet-6/part-4-building-a-middleware-pipeline-with-webapplication.html#空管道" class="sidebar-link reco-side-空管道" data-v-b57cc07c>空管道</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/2022/exploring-dotnet-6/part-4-building-a-middleware-pipeline-with-webapplication.html#具有额外中间件的管道" class="sidebar-link reco-side-具有额外中间件的管道" data-v-b57cc07c>具有额外中间件的管道</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/2022/exploring-dotnet-6/part-4-building-a-middleware-pipeline-with-webapplication.html#hello-world-管道" class="sidebar-link reco-side-hello-world-管道" data-v-b57cc07c>&quot;Hello World&quot; 管道</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/2022/exploring-dotnet-6/part-4-building-a-middleware-pipeline-with-webapplication.html#具有-userouting-的管道" class="sidebar-link reco-side-具有-userouting-的管道" data-v-b57cc07c>具有 UseRouting() 的管道</a></li><li class="level-3" data-v-b57cc07c><a href="/blogs/2022/exploring-dotnet-6/part-4-building-a-middleware-pipeline-with-webapplication.html#具有-useendpoints-的管道" class="sidebar-link reco-side-具有-useendpoints-的管道" data-v-b57cc07c>具有 UseEndpoints() 的管道</a></li><li class="level-2" data-v-b57cc07c><a href="/blogs/2022/exploring-dotnet-6/part-4-building-a-middleware-pipeline-with-webapplication.html#总结" class="sidebar-link reco-side-总结" data-v-b57cc07c>总结</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><!----><div class="kanbanniang" data-v-5775ee02><div class="banniang-container" style="display:;" data-v-5775ee02><div class="messageBox" style="right:68px;bottom:190px;display:none;" data-v-5775ee02>
      欢迎来到KB - GerryGe的博客
    </div> <div class="operation" style="right:90px;bottom:40px;display:;" data-v-5775ee02><i class="kbnfont kbn-ban-home ban-home" data-v-5775ee02></i> <i class="kbnfont kbn-ban-message message" data-v-5775ee02></i> <i class="kbnfont kbn-ban-close close" data-v-5775ee02></i> <a target="_blank" href="https://vuepress-theme-reco.recoluan.com/views/plugins/kanbanniang.html" data-v-5775ee02><i class="kbnfont kbn-ban-info info" data-v-5775ee02></i></a> <i class="kbnfont kbn-ban-theme skin" style="display:;" data-v-5775ee02></i></div> <canvas id="banniang" width="150" height="220" class="live2d" style="right:90px;bottom:-20px;opacity:0.9;" data-v-5775ee02></canvas></div> <div class="showBanNiang" style="display:none;" data-v-5775ee02>
    看板娘
  </div></div></div></div>
    <script src="/assets/js/app.ef01f0fb.js" defer></script><script src="/assets/js/4.1a620e6f.js" defer></script><script src="/assets/js/1.0577eaba.js" defer></script><script src="/assets/js/9.bb509c3d.js" defer></script>
  </body>
</html>
